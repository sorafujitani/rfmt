# Dockerfile for testing rfmt gem installation across Ruby versions
# Usage: docker build --build-arg RUBY_VERSION=4.0 -f docker/Dockerfile.test -t rfmt-test:4.0 .

ARG RUBY_VERSION=3.4
FROM ruby:${RUBY_VERSION}

# Install Rust toolchain
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
ENV PATH="/root/.cargo/bin:${PATH}"

# Install build dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    libclang-dev \
    clang \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /rfmt

# Copy only gemspec and necessary files first (for layer caching)
COPY rfmt.gemspec Gemfile Gemfile.lock ./
COPY lib/rfmt/version.rb ./lib/rfmt/

# Copy source code
COPY . .

# Build the gem
RUN gem build rfmt.gemspec

# Test gem installation (the critical test!)
RUN gem install ./rfmt-*.gem --no-document

# Verify installation works
RUN ruby -e "require 'rfmt'; puts \"rfmt #{Rfmt::VERSION} loaded successfully on Ruby #{RUBY_VERSION}\""

# Run a simple format test
RUN echo 'def hello() puts "world" end' | rfmt || echo "CLI test completed"

CMD ["ruby", "-e", "require 'rfmt'; puts \"rfmt #{Rfmt::VERSION} ready on Ruby #{RUBY_VERSION}\""]
