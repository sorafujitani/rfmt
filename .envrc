# Automatically load Nix flake development environment
use flake

# Layout for Python/Ruby projects - creates isolated environment
layout_dir="$PWD/.direnv"
mkdir -p "$layout_dir"

# Automatically install dependencies when entering the directory
if [[ ! -f ".dependencies-installed" ]]; then
    echo "ðŸ”„ First time setup - installing dependencies..."
    
    # Install Ruby gems
    if command -v bundle &> /dev/null; then
        echo "ðŸ“¦ Installing Ruby dependencies..."
        bundle install
        
        # Compile Rust extension
        echo "ðŸ”¨ Compiling Rust extension..."
        bundle exec rake compile
        
        # Mark as installed
        touch .dependencies-installed
        echo "âœ… Dependencies installed successfully!"
    else
        echo "âš ï¸  Bundle command not available yet, please run 'bundle install' manually"
    fi
fi

# Show helpful information when entering the directory
echo ""
echo "ðŸš€ rfmt development environment loaded!"
echo "ðŸ“ Current directory: $(pwd)"
echo "ðŸ Ruby: $(ruby --version | head -1)"
echo "ðŸ¦€ Rust: $(rustc --version)"
echo ""
echo "ðŸ’¡ Quick commands:"
echo "  bundle install              # Install/update Ruby dependencies"
echo "  bundle exec rake compile    # Compile Rust extension"
echo "  bundle exec rspec           # Run Ruby tests"
echo "  cargo test --manifest-path ext/rfmt/Cargo.toml  # Run Rust tests"
echo "  bundle exec rubocop         # Ruby linting"
echo "  cargo clippy --manifest-path ext/rfmt/Cargo.toml  # Rust linting"
echo "  bundle exec rake clean      # Clean build artifacts"
echo ""

# Set useful aliases for development
alias rspec='bundle exec rspec'
alias rubocop='bundle exec rubocop'
alias rake='bundle exec rake'
alias rfmt-test='bundle exec rspec && cargo test --manifest-path ext/rfmt/Cargo.toml'
alias rfmt-lint='bundle exec rubocop && cargo clippy --manifest-path ext/rfmt/Cargo.toml'
alias rfmt-format='bundle exec rubocop -a && cargo fmt --manifest-path ext/rfmt/Cargo.toml'

# Watch mode for development (requires entr or similar)
if command -v find &> /dev/null && command -v entr &> /dev/null; then
    alias watch-tests='find . -name "*.rb" -o -name "*.rs" | entr -c bundle exec rspec'
fi

export DIRENV_WARN_TIMEOUT=30s