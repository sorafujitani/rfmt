# Automatically load Nix flake development environment
use flake

# Layout for Python/Ruby projects - creates isolated environment
layout_dir="$PWD/.direnv"
mkdir -p "$layout_dir"

# Automatically install dependencies when entering the directory
if [[ ! -f ".dependencies-installed" ]]; then
    echo "ðŸ”„ First time setup - installing dependencies..."

    # Install Ruby gems
    if command -v bundle &> /dev/null; then
        echo "ðŸ“¦ Installing Ruby dependencies..."
        bundle install

        # Compile Rust extension
        echo "ðŸ”¨ Compiling Rust extension..."
        bundle exec rake compile

        # Mark as installed
        touch .dependencies-installed
        echo "âœ… Dependencies installed successfully!"
    else
        echo "âš ï¸  Bundle command not available yet, please run 'bundle install' manually"
    fi
fi

# Show brief info when entering the directory  
echo "ðŸ“ rfmt | direnv loaded"

# Set useful aliases for development
alias rspec='bundle exec rspec'
alias rubocop='bundle exec rubocop'
alias rake='bundle exec rake'
alias rfmt-test='bundle exec rspec && cargo test --manifest-path ext/rfmt/Cargo.toml'
alias rfmt-lint='bundle exec rubocop && cargo clippy --manifest-path ext/rfmt/Cargo.toml'
alias rfmt-format='bundle exec rubocop -a && cargo fmt --manifest-path ext/rfmt/Cargo.toml'

# Watch mode for development (requires entr or similar)
if command -v find &> /dev/null && command -v entr &> /dev/null; then
    alias watch-tests='find . -name "*.rb" -o -name "*.rs" | entr -c bundle exec rspec'
fi

export DIRENV_WARN_TIMEOUT=30s
