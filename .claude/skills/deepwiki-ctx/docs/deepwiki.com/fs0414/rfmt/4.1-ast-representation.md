---
title: "AST Representation | fs0414/rfmt | DeepWiki"
source_url: "https://deepwiki.com/fs0414/rfmt/4.1-ast-representation"
fetched_at: "2026-01-13T10:53:43.101777+00:00"
---



Loading...

Index your code with Devin

[DeepWiki](https://deepwiki.com/)

[DeepWiki](https://deepwiki.com/)

[fs0414/rfmt](https://github.com/fs0414/rfmt "Open repository")

Index your code with

Devin

Edit WikiShare

Loading...

Last indexed: 3 January 2026 ([90c575](https://github.com/fs0414/rfmt/commits/90c575e6))

* [Overview](https://deepwiki.com/fs0414/rfmt/1-overview.html)
* [Architecture Overview](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html)
* [Key Concepts](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html)
* [Getting Started](https://deepwiki.com/fs0414/rfmt/2-getting-started.html)
* [Installation](https://deepwiki.com/fs0414/rfmt/2.1-installation.html)
* [Configuration](https://deepwiki.com/fs0414/rfmt/2.2-configuration.html)
* [User Guides](https://deepwiki.com/fs0414/rfmt/3-user-guides.html)
* [CLI Usage](https://deepwiki.com/fs0414/rfmt/3.1-cli-usage.html)
* [Ruby API](https://deepwiki.com/fs0414/rfmt/3.2-ruby-api.html)
* [Editor Integration](https://deepwiki.com/fs0414/rfmt/3.3-editor-integration.html)
* [Core Systems](https://deepwiki.com/fs0414/rfmt/4-core-systems.html)
* [AST Representation](https://deepwiki.com/fs0414/rfmt/4.1-ast-representation.html)
* [Formatting Engine (Emitter)](https://deepwiki.com/fs0414/rfmt/4.2-formatting-engine-(emitter).html)
* [Parser Integration (PrismBridge)](https://deepwiki.com/fs0414/rfmt/4.3-parser-integration-(prismbridge).html)
* [Configuration System](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html)
* [Caching System](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html)
* [Logging System](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html)
* [Formatting Behavior](https://deepwiki.com/fs0414/rfmt/5-formatting-behavior.html)
* [Control Flow Formatting](https://deepwiki.com/fs0414/rfmt/5.1-control-flow-formatting.html)
* [Exception Handling Formatting](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html)
* [Lambda and Block Formatting](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html)
* [Development](https://deepwiki.com/fs0414/rfmt/6-development.html)
* [Building from Source](https://deepwiki.com/fs0414/rfmt/6.1-building-from-source.html)
* [Testing](https://deepwiki.com/fs0414/rfmt/6.2-testing.html)
* [Release Process](https://deepwiki.com/fs0414/rfmt/6.3-release-process.html)
* [Reference](https://deepwiki.com/fs0414/rfmt/7-reference.html)
* [Node Types Reference](https://deepwiki.com/fs0414/rfmt/7.1-node-types-reference.html)
* [Configuration Options Reference](https://deepwiki.com/fs0414/rfmt/7.2-configuration-options-reference.html)
* [Error Codes Reference](https://deepwiki.com/fs0414/rfmt/7.3-error-codes-reference.html)
* [Performance and Benchmarks](https://deepwiki.com/fs0414/rfmt/7.4-performance-and-benchmarks.html)

Menu

# AST Representation

Relevant source files

* [docs/development-notes.md](https://github.com/fs0414/rfmt/blob/90c575e6/docs/development-notes.md)
* [ext/rfmt/src/ast/mod.rs](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs)
* [ext/rfmt/src/emitter/mod.rs](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs)
* [lib/rfmt/prism\_bridge.rb](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb)
* [lib/rfmt/prism\_node\_extractor.rb](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_node_extractor.rb)

## Purpose and Scope

This document describes rfmt's internal Abstract Syntax Tree (AST) representation. The AST is the core data structure that bridges Ruby's Prism parser and Rust's formatting engine. This page covers the `Node` structure, the `NodeType` enumeration of 80+ Ruby syntax constructs, position tracking via `Location`, comment attachment via `Comment`, formatting metadata via `FormattingInfo`, and the JSON serialization protocol used to transfer AST data across the FFI boundary.

For information about how this AST is generated from Ruby source code, see [Parser Integration (PrismBridge)](https://deepwiki.com/fs0414/rfmt/4.3-parser-integration-(prismbridge).html). For details on how the AST is consumed during formatting, see [Formatting Engine (Emitter)](https://deepwiki.com/fs0414/rfmt/4.2-formatting-engine-(emitter).html).

---

## Node Structure

The `Node` struct is the fundamental unit of rfmt's AST representation, defined in Rust and deserialized from JSON data sent by Ruby.

**Node Field Descriptions**

| Field | Type | Purpose |
| --- | --- | --- |
| `node_type` | `NodeType` | Discriminates the Ruby syntax construct (class, method, call, etc.) |
| `location` | `Location` | Tracks exact position in source code (lines, columns, byte offsets) |
| `children` | `Vec<Node>` | Child AST nodes representing nested syntax elements |
| `metadata` | `HashMap<String, String>` | Node-specific data extracted by PrismNodeExtractor (names, counts, etc.) |
| `comments` | `Vec<Comment>` | Comments attached directly to this node |
| `formatting` | `FormattingInfo` | Formatting state and metadata for emission |

Sources: [ext/rfmt/src/ast/mod.rs4-14](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L4-L14)

---

## NodeType Taxonomy

The `NodeType` enum categorizes over 80 different Ruby syntax constructs. Each variant corresponds to a Prism parser node type and determines how the Emitter formats the construct.

**Major NodeType Categories**

| Category | Example Variants | Count | Purpose |
| --- | --- | --- | --- |
| **Program & Structure** | `ProgramNode`, `StatementsNode` | 2 | Root and statement list nodes |
| **Definitions** | `ClassNode`, `ModuleNode`, `DefNode` | 3 | Class, module, method definitions |
| **Control Flow** | `IfNode`, `UnlessNode`, `CaseNode`, `WhileNode`, `ForNode` | 8+ | Conditionals and loops |
| **Exception Handling** | `BeginNode`, `RescueNode`, `EnsureNode` | 4 | Exception handling constructs |
| **Literals** | `StringNode`, `IntegerNode`, `ArrayNode`, `HashNode` | 9 | Literal values |
| **Variables** | `LocalVariableReadNode`, `InstanceVariableReadNode` | 20+ | Variable reads/writes (local, instance, class, global) |
| **Blocks & Lambdas** | `BlockNode`, `LambdaNode` | 2 | Block and lambda definitions |
| **Parameters** | `RequiredParameterNode`, `KeywordParameterNode` | 8 | Method parameter nodes (structural) |
| **Expressions** | `CallNode`, `OrNode`, `AndNode`, `RangeNode` | 15+ | Method calls, operators, ranges |
| **Interpolation** | `InterpolatedStringNode`, `EmbeddedStatementsNode` | 5+ | String interpolation constructs |
| **Pattern Matching** | `CaseMatchNode`, `InNode` | 4 | Pattern matching (Ruby 2.7+) |
| **Other** | `SelfNode`, `ParenthesesNode`, `DefinedNode` | 10+ | Miscellaneous constructs |

**NodeType Conversion**

The Ruby `PrismBridge` converts Prism node class names to snake\_case strings, which the Rust `NodeType::from_str` method deserializes:

```
Prism::ClassNode → "class_node" → NodeType::ClassNode
Prism::DefNode → "def_node" → NodeType::DefNode
```

Unknown node types are captured as `NodeType::Unknown(String)` to prevent deserialization failures.

Sources: [ext/rfmt/src/ast/mod.rs27-184](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L27-L184) [ext/rfmt/src/ast/mod.rs186-295](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L186-L295) [lib/rfmt/prism\_bridge.rb100-106](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L100-L106)

---

## Location Tracking

The `Location` struct captures precise position information for each AST node, enabling source extraction and comment positioning.

**Location Fields**

| Field | Type | Description | Example |
| --- | --- | --- | --- |
| `start_line` | `usize` | Line where node begins (1-indexed) | `5` for line 5 |
| `start_column` | `usize` | Column where node begins (0-indexed) | `2` for 3rd character |
| `end_line` | `usize` | Line where node ends (1-indexed) | `7` for line 7 |
| `end_column` | `usize` | Column where node ends (0-indexed) | `10` for 11th character |
| `start_offset` | `usize` | Byte offset from file start | `42` bytes into file |
| `end_offset` | `usize` | Byte offset to node end | `89` bytes into file |

**Source Extraction Example**

The Emitter uses byte offsets to extract original source text for complex constructs:

Sources: [ext/rfmt/src/ast/mod.rs16-25](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L16-L25) [ext/rfmt/src/ast/mod.rs405-437](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L405-L437) [lib/rfmt/prism\_bridge.rb108-119](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L108-L119)

---

## Comment Representation

Comments are preserved and repositioned during formatting. The `Comment` struct tracks comment text, position, type, and attachment position.

**Comment Structure**

| Field | Type | Description |
| --- | --- | --- |
| `text` | `String` | Full comment text including `#` prefix or `=begin`/`=end` markers |
| `location` | `Location` | Position in source (used to determine attachment) |
| `comment_type` | `CommentType` | `Line` (`#`) or `Block` (`=begin...=end`) |
| `position` | `CommentPosition` | `Leading`, `Trailing`, or `Inner` relative to node |

**Comment Type Enum**

**Comment Position Enum**

**Comment Collection and Emission**

The Emitter recursively collects all comments from the AST and emits them based on their line numbers relative to nodes:

Comments are emitted in three contexts:

1. **Before nodes** - `emit_comments_before(line, indent_level)` emits comments with `end_line < node.start_line`
2. **Trailing** - `emit_trailing_comments(line)` emits comments on the same line as code
3. **Remaining** - `emit_remaining_comments()` emits orphaned comments at file end

Sources: [ext/rfmt/src/ast/mod.rs307-327](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L307-L327) [ext/rfmt/src/emitter/mod.rs85-91](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L85-L91) [ext/rfmt/src/emitter/mod.rs94-146](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L94-L146) [lib/rfmt/prism\_bridge.rb63-84](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L63-L84)

---

## FormattingInfo

The `FormattingInfo` struct stores formatting state and metadata attached to each node. While most fields are computed during emission, `multiline` is set during AST conversion.

**FormattingInfo Fields**

| Field | Type | Purpose | Set By |
| --- | --- | --- | --- |
| `indent_level` | `usize` | Current indentation depth (0 = top-level) | Emitter during formatting |
| `needs_blank_line_before` | `bool` | Should emit blank line before node | Future use |
| `needs_blank_line_after` | `bool` | Should emit blank line after node | Future use |
| `preserve_newlines` | `bool` | Preserve original newline count | Future use |
| `multiline` | `bool` | Node spans multiple lines (`start_line != end_line`) | PrismBridge during conversion |
| `original_formatting` | `Option<String>` | Original source text for reference | Future use |

**Multiline Detection**

The Ruby `PrismBridge` sets `multiline` during AST conversion:

This field helps the Emitter decide between inline and block formatting, particularly for blocks and hash literals.

Sources: [ext/rfmt/src/ast/mod.rs329-338](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L329-L338) [lib/rfmt/prism\_bridge.rb377-388](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L377-L388)

---

## Metadata Extraction

The `metadata` HashMap stores node-specific information extracted by `PrismNodeExtractor`. This metadata enables the Emitter to reconstruct syntax without parsing child nodes.

**Metadata by Node Type**

| Node Type | Metadata Keys | Example Values | Purpose |
| --- | --- | --- | --- |
| `ClassNode` | `name`, `superclass` | `"User"`, `"ApplicationRecord"` | Class definition header |
| `ModuleNode` | `name` | `"Authentication"` | Module definition header |
| `DefNode` | `name`, `parameters_count`, `receiver` | `"authenticate"`, `"2"`, `"self"` | Method signature |
| `CallNode` | `name`, `message` | `"user"`, `"save"` | Method call details |
| `StringNode` | `content` | `"Hello, world!"` | String literal value |
| `IntegerNode` | `value` | `"42"` | Integer literal value |
| `IfNode`/`UnlessNode` | `is_ternary` | `"true"`, `"false"` | Ternary vs. block if |

**Metadata Extraction Flow**

**Example: DefNode Metadata Extraction**

This metadata enables the Rust Emitter to emit `def self.authenticate(email, password)` without parsing parameter child nodes.

Sources: [lib/rfmt/prism\_bridge.rb309-368](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L309-L368) [lib/rfmt/prism\_node\_extractor.rb1-115](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_node_extractor.rb#L1-L115)

---

## Serialization and Deserialization

The AST crosses the FFI boundary as JSON, serialized by Ruby's `PrismBridge` and deserialized by Rust's `serde_json`.

**Serialization Flow**

**JSON Format Structure**

The JSON payload contains two top-level keys:

**Recursive Conversion**

The Ruby `convert_node` method recursively converts the Prism AST:

**Deserialization in Rust**

The Rust `Node` struct uses `serde` derives for automatic JSON deserialization:

The `NodeType` enum uses `#[serde(rename_all = "snake_case")]` to match Ruby's snake\_case naming convention.

Sources: [lib/rfmt/prism\_bridge.rb58-84](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L58-L84) [lib/rfmt/prism\_bridge.rb86-98](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L86-L98) [ext/rfmt/src/ast/mod.rs1-14](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L1-L14) [ext/rfmt/src/ast/mod.rs28-29](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L28-L29)

---

## Child Node Extraction

The `extract_children` method in `PrismBridge` handles the complexity of extracting child nodes from Prism's varied node structures. Each Prism node type has different accessor methods for its children.

**Child Extraction by Node Type**

| Node Type | Child Accessors | Example Children |
| --- | --- | --- |
| `ProgramNode` | `statements.body` | Top-level statements |
| `ClassNode` | `constant_path`, `superclass`, `body` | Class name, parent class, body statements |
| `DefNode` | `parameters.child_nodes`, `body` | Method parameters, body statements |
| `CallNode` | `receiver`, `arguments.child_nodes`, `block` | Receiver object, arguments, block |
| `IfNode` | `predicate`, `statements`, `consequent` | Condition, then clause, elsif/else |
| `BeginNode` | `statements`, `rescue_clause`, `ensure_clause` | Body, rescue, ensure |
| `RescueNode` | `exceptions`, `reference`, `statements`, `subsequent` | Exception classes, variable, body, next rescue |
| `BlockNode` | `parameters.child_nodes`, `body` | Block parameters, body statements |

**Example: CallNode Children**

This extracts children for a call like `user.authenticate(email, password) { |result| ... }`, resulting in:

1. `receiver`: `user` (LocalVariableReadNode)
2. `arguments`: `[email, password]` (LocalVariableReadNodes)
3. `block`: Block definition (BlockNode)

**Structural vs. Semantic Children**

Some children are "structural" (part of the node's definition) rather than "semantic" (executable statements):

* `ConstantReadNode` in `ClassNode` (the class name)
* `ConstantPathNode` in `ModuleNode` (the module name)
* `RequiredParameterNode` in `DefNode` (parameter definitions)

The Emitter uses `is_structural_node()` to skip these during body emission, as they're already emitted in the definition header.

Sources: [lib/rfmt/prism\_bridge.rb121-307](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L121-L307) [ext/rfmt/src/emitter/mod.rs1010-1027](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L1010-L1027)

---

## Unknown Node Handling

Rfmt uses a defensive design pattern to handle Prism node types that haven't been explicitly mapped. The `NodeType::Unknown(String)` variant captures the node type name, preventing deserialization failures.

**Unknown Node Workflow**

**Rust Unknown Handling**

**Emitter Fallback**

The Emitter's `emit_node` method routes unknown nodes to `emit_generic`, which extracts the original source text:

This design ensures rfmt continues to function as Ruby and Prism evolve, though unknown nodes receive minimal formatting (source extraction only).

Sources: [ext/rfmt/src/ast/mod.rs186-295](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L186-L295) [ext/rfmt/src/emitter/mod.rs148-171](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L148-L171) [ext/rfmt/src/emitter/mod.rs988-1001](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L988-L1001)

Dismiss

Refresh this wiki

Enter email to refresh

### On this page

* [AST Representation](https://deepwiki.com/fs0414/rfmt/4.1-ast-representation.html#ast-representation)
* [Purpose and Scope](https://deepwiki.com/fs0414/rfmt/4.1-ast-representation.html#purpose-and-scope)
* [Node Structure](https://deepwiki.com/fs0414/rfmt/4.1-ast-representation.html#node-structure)
* [NodeType Taxonomy](https://deepwiki.com/fs0414/rfmt/4.1-ast-representation.html#nodetype-taxonomy)
* [Location Tracking](https://deepwiki.com/fs0414/rfmt/4.1-ast-representation.html#location-tracking)
* [Comment Representation](https://deepwiki.com/fs0414/rfmt/4.1-ast-representation.html#comment-representation)
* [FormattingInfo](https://deepwiki.com/fs0414/rfmt/4.1-ast-representation.html#formattinginfo)
* [Metadata Extraction](https://deepwiki.com/fs0414/rfmt/4.1-ast-representation.html#metadata-extraction)
* [Serialization and Deserialization](https://deepwiki.com/fs0414/rfmt/4.1-ast-representation.html#serialization-and-deserialization)
* [Child Node Extraction](https://deepwiki.com/fs0414/rfmt/4.1-ast-representation.html#child-node-extraction)
* [Unknown Node Handling](https://deepwiki.com/fs0414/rfmt/4.1-ast-representation.html#unknown-node-handling)
