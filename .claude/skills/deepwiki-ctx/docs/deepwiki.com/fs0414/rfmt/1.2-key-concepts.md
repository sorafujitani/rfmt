---
title: "Key Concepts | fs0414/rfmt | DeepWiki"
source_url: "https://deepwiki.com/fs0414/rfmt/1.2-key-concepts"
fetched_at: "2026-01-13T10:53:43.101777+00:00"
---



Loading...

Index your code with Devin

[DeepWiki](https://deepwiki.com/)

[DeepWiki](https://deepwiki.com/)

[fs0414/rfmt](https://github.com/fs0414/rfmt "Open repository")

Index your code with

Devin

Edit WikiShare

Loading...

Last indexed: 3 January 2026 ([90c575](https://github.com/fs0414/rfmt/commits/90c575e6))

* [Overview](https://deepwiki.com/fs0414/rfmt/1-overview.html)
* [Architecture Overview](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html)
* [Key Concepts](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html)
* [Getting Started](https://deepwiki.com/fs0414/rfmt/2-getting-started.html)
* [Installation](https://deepwiki.com/fs0414/rfmt/2.1-installation.html)
* [Configuration](https://deepwiki.com/fs0414/rfmt/2.2-configuration.html)
* [User Guides](https://deepwiki.com/fs0414/rfmt/3-user-guides.html)
* [CLI Usage](https://deepwiki.com/fs0414/rfmt/3.1-cli-usage.html)
* [Ruby API](https://deepwiki.com/fs0414/rfmt/3.2-ruby-api.html)
* [Editor Integration](https://deepwiki.com/fs0414/rfmt/3.3-editor-integration.html)
* [Core Systems](https://deepwiki.com/fs0414/rfmt/4-core-systems.html)
* [AST Representation](https://deepwiki.com/fs0414/rfmt/4.1-ast-representation.html)
* [Formatting Engine (Emitter)](https://deepwiki.com/fs0414/rfmt/4.2-formatting-engine-(emitter).html)
* [Parser Integration (PrismBridge)](https://deepwiki.com/fs0414/rfmt/4.3-parser-integration-(prismbridge).html)
* [Configuration System](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html)
* [Caching System](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html)
* [Logging System](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html)
* [Formatting Behavior](https://deepwiki.com/fs0414/rfmt/5-formatting-behavior.html)
* [Control Flow Formatting](https://deepwiki.com/fs0414/rfmt/5.1-control-flow-formatting.html)
* [Exception Handling Formatting](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html)
* [Lambda and Block Formatting](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html)
* [Development](https://deepwiki.com/fs0414/rfmt/6-development.html)
* [Building from Source](https://deepwiki.com/fs0414/rfmt/6.1-building-from-source.html)
* [Testing](https://deepwiki.com/fs0414/rfmt/6.2-testing.html)
* [Release Process](https://deepwiki.com/fs0414/rfmt/6.3-release-process.html)
* [Reference](https://deepwiki.com/fs0414/rfmt/7-reference.html)
* [Node Types Reference](https://deepwiki.com/fs0414/rfmt/7.1-node-types-reference.html)
* [Configuration Options Reference](https://deepwiki.com/fs0414/rfmt/7.2-configuration-options-reference.html)
* [Error Codes Reference](https://deepwiki.com/fs0414/rfmt/7.3-error-codes-reference.html)
* [Performance and Benchmarks](https://deepwiki.com/fs0414/rfmt/7.4-performance-and-benchmarks.html)

Menu

# Key Concepts

Relevant source files

* [README.md](https://github.com/fs0414/rfmt/blob/90c575e6/README.md)
* [ext/rfmt/src/ast/mod.rs](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs)
* [ext/rfmt/src/emitter/mod.rs](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs)
* [lib/rfmt/prism\_bridge.rb](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb)
* [lib/rfmt/prism\_node\_extractor.rb](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_node_extractor.rb)

This page defines the core terminology, data structures, and components of rfmt. Understanding these concepts is essential for working with rfmt, whether as a user configuring formatting rules or as a developer extending the system.

For information about how these components fit into the overall system architecture, see [Architecture Overview](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html). For details on how the formatting engine applies these concepts, see [Formatting Engine (Emitter)](https://deepwiki.com/fs0414/rfmt/4.2-formatting-engine-(emitter).html).

## Purpose and Scope

This document explains:

* **Core data structures**: `Node`, `NodeType`, `Location`, `Comment`, and their relationships
* **Parser integration**: How `PrismBridge` converts Ruby source to AST
* **Formatting engine**: How `Emitter` transforms AST back to formatted code
* **Formatting rules**: Configuration options that control output style
* **Comment preservation**: The mechanism for maintaining comment placement

## Abstract Syntax Tree (AST)

The **Abstract Syntax Tree** is rfmt's internal representation of Ruby source code. The AST is a tree structure where each node represents a syntactic construct (class, method, expression, etc.).

### Node Structure

The `Node` struct is the fundamental building block of the AST:

**Sources:** [ext/rfmt/src/ast/mod.rs4-14](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L4-L14)

| Field | Type | Purpose |
| --- | --- | --- |
| `node_type` | `NodeType` | Identifies the type of syntax construct (ClassNode, DefNode, etc.) |
| `location` | `Location` | Position in source code (line, column, offset) |
| `children` | `Vec<Node>` | Child nodes forming the tree structure |
| `metadata` | `HashMap<String, String>` | Type-specific information (names, parameter counts, etc.) |
| `comments` | `Vec<Comment>` | Comments associated with this node |
| `formatting` | `FormattingInfo` | Formatting metadata (indent level, blank lines, etc.) |

**Sources:** [ext/rfmt/src/ast/mod.rs7-14](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L7-L14)

### Location Tracking

The `Location` struct captures precise position information for each node:

**Sources:** [ext/rfmt/src/ast/mod.rs16-25](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L16-L25)

This dual coordinate system (line/column + byte offset) enables:

* **Accurate comment positioning**: Comments placed based on line numbers
* **Source extraction**: Original text retrieved using byte offsets
* **Error reporting**: Precise location information for debugging

**Sources:** [ext/rfmt/src/ast/mod.rs16-25](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L16-L25)

## Node Types

The `NodeType` enum categorizes all Ruby syntax constructs rfmt understands. With 80+ variants, it covers definitions, expressions, literals, variables, control flow, and exception handling.

### NodeType Hierarchy

**Sources:** [ext/rfmt/src/ast/mod.rs28-184](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L28-L184)

### Key NodeType Categories

| Category | Examples | Purpose |
| --- | --- | --- |
| **Structural** | `ProgramNode`, `StatementsNode` | Root and statement container nodes |
| **Definitions** | `ClassNode`, `ModuleNode`, `DefNode` | Class, module, and method definitions |
| **Expressions** | `CallNode`, `IfNode`, `UnlessNode` | Method calls and conditionals |
| **Literals** | `StringNode`, `IntegerNode`, `ArrayNode`, `HashNode` | Literal values |
| **Variables** | `LocalVariableReadNode`, `InstanceVariableWriteNode` | Variable access and assignment |
| **Control Flow** | `WhileNode`, `ForNode`, `CaseNode`, `WhenNode` | Loops and case statements |
| **Exception Handling** | `BeginNode`, `RescueNode`, `EnsureNode` | Exception handling constructs |
| **Blocks** | `BlockNode`, `LambdaNode` | Block and lambda expressions |
| **Parameters** | `RequiredParameterNode`, `KeywordParameterNode` | Method parameter nodes |

**Sources:** [ext/rfmt/src/ast/mod.rs30-184](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L30-L184)

### NodeType String Conversion

NodeType names follow a consistent snake\_case convention matching Prism's naming:

```
Prism::ClassNode → "class_node" → NodeType::ClassNode
Prism::DefNode → "def_node" → NodeType::DefNode
Prism::CallNode → "call_node" → NodeType::CallNode
```

**Sources:** [ext/rfmt/src/ast/mod.rs186-295](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L186-L295) [lib/rfmt/prism\_bridge.rb100-106](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L100-L106)

## Parser Integration: PrismBridge

`PrismBridge` is the Ruby-side component that integrates with the Prism parser and converts its AST to rfmt's JSON representation.

### PrismBridge Data Flow

**Sources:** [lib/rfmt/prism\_bridge.rb20-26](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L20-L26) [lib/rfmt/prism\_bridge.rb87-98](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L87-L98)

### AST Conversion Process

For each Prism node, `PrismBridge` extracts:

1. **node\_type**: Converted from Prism class name (e.g., `Prism::ClassNode` → `"class_node"`)
2. **location**: Line, column, and byte offset information
3. **children**: Child nodes based on node type (different nodes have different child accessors)
4. **metadata**: Node-specific information extracted by `PrismNodeExtractor`
5. **comments**: Empty array (comments handled separately at parse result level)
6. **formatting**: Initial formatting hints (multiline detection, etc.)

**Sources:** [lib/rfmt/prism\_bridge.rb87-98](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L87-L98) [lib/rfmt/prism\_bridge.rb122-307](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L122-L307)

### Metadata Extraction

`PrismNodeExtractor` extracts type-specific metadata:

| Node Type | Metadata Fields | Extractor Method |
| --- | --- | --- |
| `ClassNode` | `name`, `superclass` | `extract_class_or_module_name`, `extract_superclass_name` |
| `ModuleNode` | `name` | `extract_class_or_module_name` |
| `DefNode` | `name`, `parameters_count`, `receiver` | `extract_node_name`, `extract_parameter_count` |
| `CallNode` | `name`, `message` | `extract_node_name`, `extract_message_name` |
| `StringNode` | `content` | `extract_string_content` |
| `IntegerNode`, `FloatNode`, `SymbolNode` | `value` | `extract_literal_value` |

**Sources:** [lib/rfmt/prism\_bridge.rb310-368](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L310-L368) [lib/rfmt/prism\_node\_extractor.rb1-115](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_node_extractor.rb#L1-L115)

### JSON Serialization Format

The final JSON structure contains both AST and comments:

**Sources:** [lib/rfmt/prism\_bridge.rb63-84](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L63-L84)

## Formatting Engine: Emitter

The `Emitter` is the Rust-side component that converts the AST back into formatted Ruby source code.

### Emitter Architecture

**Sources:** [ext/rfmt/src/emitter/mod.rs14-30](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L14-L30)

### Emitter Dispatch Pattern

The Emitter uses a dispatch pattern to route each node type to specialized formatting logic:

**Sources:** [ext/rfmt/src/emitter/mod.rs149-171](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L149-L171)

### Source Extraction Strategy

For complex syntax that's difficult to reconstruct (method parameters, lambda syntax, block parameters), the Emitter extracts the original source text using byte offsets:

**Example: Method Parameters**

**Sources:** [ext/rfmt/src/emitter/mod.rs342-358](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L342-L358)

This hybrid approach balances:

* **Custom formatting** for structural elements (classes, methods, control flow)
* **Source extraction** for complex details that preserve original style

**Sources:** [ext/rfmt/src/emitter/mod.rs988-1001](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L988-L1001)

## Comment Preservation

Comment preservation is a critical feature that maintains developer annotations during formatting.

### Comment Data Structure

**Sources:** [ext/rfmt/src/ast/mod.rs308-327](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L308-L327)

### Comment Types

| Type | Example | Representation |
| --- | --- | --- |
| **Line** | `# This is a comment` | `CommentType::Line` |
| **Block** | `=begin...=end` | `CommentType::Block` |

**Sources:** [ext/rfmt/src/ast/mod.rs316-320](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L316-L320)

### Comment Positions

| Position | Description | Timing |
| --- | --- | --- |
| **Leading** | Comments before a node | Emitted before the node |
| **Trailing** | Comments on the same line as a node | Emitted after the node on same line |
| **Inner** | Comments inside a node | Emitted during node body |

**Sources:** [ext/rfmt/src/ast/mod.rs322-327](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L322-L327)

### Comment Preservation Flow

**Sources:** [ext/rfmt/src/emitter/mod.rs45-83](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L45-L83) [ext/rfmt/src/emitter/mod.rs86-146](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L86-L146)

### Comment Tracking Mechanism

The Emitter maintains an `emitted_comment_indices` vector to track which comments have been emitted, preventing duplicates:

1. **Collection**: All comments collected recursively from AST ([ext/rfmt/src/emitter/mod.rs86-91](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L86-L91))
2. **Emission**: Comments emitted based on line number and position ([ext/rfmt/src/emitter/mod.rs94-123](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L94-L123))
3. **Tracking**: Emitted comment indices recorded ([ext/rfmt/src/emitter/mod.rs114](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L114-L114))
4. **Cleanup**: Remaining unemitted comments output at end ([ext/rfmt/src/emitter/mod.rs65-83](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L65-L83))

**Sources:** [ext/rfmt/src/emitter/mod.rs18-19](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L18-L19) [ext/rfmt/src/emitter/mod.rs47-48](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L47-L48)

## Formatting Rules

Formatting rules are configuration options that control the output style. These are defined in the `Config` struct and applied by the Emitter.

### Core Formatting Options

| Option | Type | Default | Range | Purpose |
| --- | --- | --- | --- | --- |
| `line_length` | Integer | 100 | 40-500 | Maximum line width |
| `indent_width` | Integer | 2 | 1-8 | Spaces/tabs per indent level |
| `indent_style` | Enum | `spaces` | `spaces`, `tabs` | Indentation character |
| `quote_style` | Enum | `double` | `double`, `single`, `consistent` | String quote preference |
| `hash_syntax` | Enum | `ruby19` | `ruby19`, `hash_rockets`, `consistent` | Hash key syntax |
| `trailing_comma` | Enum | `multiline` | `always`, `never`, `multiline` | Trailing comma rules |

**Sources:** [ext/rfmt/src/config/mod.rs](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs) (referenced in Diagram 4 from context)

### IndentStyle Application

The Emitter applies indentation based on configuration:

**Sources:** [ext/rfmt/src/emitter/mod.rs95-98](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L95-L98)

### Blank Line Normalization

The Emitter normalizes blank lines between statements while preserving intentional spacing:

* **Single statements**: 1 newline (no blank line)
* **Multiple statements with gap**: 2 newlines (1 blank line)
* **Top-level definitions**: Normalizes to max 1 blank line

**Sources:** [ext/rfmt/src/emitter/mod.rs178-190](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L178-L190) [ext/rfmt/src/emitter/mod.rs199-226](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L199-L226)

## FormattingInfo Metadata

Each node carries `FormattingInfo` metadata that guides formatting decisions:

**Sources:** [ext/rfmt/src/ast/mod.rs330-338](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L330-L338)

This metadata is populated during AST construction and consumed during emission to maintain formatting context.

**Sources:** [lib/rfmt/prism\_bridge.rb378-388](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L378-L388)

## Summary: Component Relationships

**Sources:** [lib/rfmt/prism\_bridge.rb20-84](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L20-L84) [ext/rfmt/src/emitter/mod.rs14-62](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L14-L62)

Understanding these key concepts provides the foundation for working with rfmt, whether configuring formatting rules, integrating with editors, or extending the formatter's capabilities. For implementation details of specific subsystems, see the [Core Systems](https://deepwiki.com/fs0414/rfmt/4-core-systems.html) section of the wiki.

Dismiss

Refresh this wiki

Enter email to refresh

### On this page

* [Key Concepts](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#key-concepts)
* [Purpose and Scope](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#purpose-and-scope)
* [Abstract Syntax Tree (AST)](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#abstract-syntax-tree-ast)
* [Node Structure](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#node-structure)
* [Location Tracking](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#location-tracking)
* [Node Types](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#node-types)
* [NodeType Hierarchy](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#nodetype-hierarchy)
* [Key NodeType Categories](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#key-nodetype-categories)
* [NodeType String Conversion](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#nodetype-string-conversion)
* [Parser Integration: PrismBridge](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#parser-integration-prismbridge)
* [PrismBridge Data Flow](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#prismbridge-data-flow)
* [AST Conversion Process](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#ast-conversion-process)
* [Metadata Extraction](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#metadata-extraction)
* [JSON Serialization Format](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#json-serialization-format)
* [Formatting Engine: Emitter](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#formatting-engine-emitter)
* [Emitter Architecture](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#emitter-architecture)
* [Emitter Dispatch Pattern](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#emitter-dispatch-pattern)
* [Source Extraction Strategy](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#source-extraction-strategy)
* [Comment Preservation](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#comment-preservation)
* [Comment Data Structure](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#comment-data-structure)
* [Comment Types](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#comment-types)
* [Comment Positions](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#comment-positions)
* [Comment Preservation Flow](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#comment-preservation-flow)
* [Comment Tracking Mechanism](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#comment-tracking-mechanism)
* [Formatting Rules](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#formatting-rules)
* [Core Formatting Options](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#core-formatting-options)
* [IndentStyle Application](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#indentstyle-application)
* [Blank Line Normalization](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#blank-line-normalization)
* [FormattingInfo Metadata](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#formattinginfo-metadata)
* [Summary: Component Relationships](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html#summary-component-relationships)
