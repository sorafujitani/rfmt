---
title: "Configuration System | fs0414/rfmt | DeepWiki"
source_url: "https://deepwiki.com/fs0414/rfmt/4.4-configuration-system"
fetched_at: "2026-01-13T10:53:43.101777+00:00"
---



Loading...

Index your code with Devin

[DeepWiki](https://deepwiki.com/)

[DeepWiki](https://deepwiki.com/)

[fs0414/rfmt](https://github.com/fs0414/rfmt "Open repository")

Index your code with

Devin

Edit WikiShare

Loading...

Last indexed: 3 January 2026 ([90c575](https://github.com/fs0414/rfmt/commits/90c575e6))

* [Overview](https://deepwiki.com/fs0414/rfmt/1-overview.html)
* [Architecture Overview](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html)
* [Key Concepts](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html)
* [Getting Started](https://deepwiki.com/fs0414/rfmt/2-getting-started.html)
* [Installation](https://deepwiki.com/fs0414/rfmt/2.1-installation.html)
* [Configuration](https://deepwiki.com/fs0414/rfmt/2.2-configuration.html)
* [User Guides](https://deepwiki.com/fs0414/rfmt/3-user-guides.html)
* [CLI Usage](https://deepwiki.com/fs0414/rfmt/3.1-cli-usage.html)
* [Ruby API](https://deepwiki.com/fs0414/rfmt/3.2-ruby-api.html)
* [Editor Integration](https://deepwiki.com/fs0414/rfmt/3.3-editor-integration.html)
* [Core Systems](https://deepwiki.com/fs0414/rfmt/4-core-systems.html)
* [AST Representation](https://deepwiki.com/fs0414/rfmt/4.1-ast-representation.html)
* [Formatting Engine (Emitter)](https://deepwiki.com/fs0414/rfmt/4.2-formatting-engine-(emitter).html)
* [Parser Integration (PrismBridge)](https://deepwiki.com/fs0414/rfmt/4.3-parser-integration-(prismbridge).html)
* [Configuration System](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html)
* [Caching System](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html)
* [Logging System](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html)
* [Formatting Behavior](https://deepwiki.com/fs0414/rfmt/5-formatting-behavior.html)
* [Control Flow Formatting](https://deepwiki.com/fs0414/rfmt/5.1-control-flow-formatting.html)
* [Exception Handling Formatting](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html)
* [Lambda and Block Formatting](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html)
* [Development](https://deepwiki.com/fs0414/rfmt/6-development.html)
* [Building from Source](https://deepwiki.com/fs0414/rfmt/6.1-building-from-source.html)
* [Testing](https://deepwiki.com/fs0414/rfmt/6.2-testing.html)
* [Release Process](https://deepwiki.com/fs0414/rfmt/6.3-release-process.html)
* [Reference](https://deepwiki.com/fs0414/rfmt/7-reference.html)
* [Node Types Reference](https://deepwiki.com/fs0414/rfmt/7.1-node-types-reference.html)
* [Configuration Options Reference](https://deepwiki.com/fs0414/rfmt/7.2-configuration-options-reference.html)
* [Error Codes Reference](https://deepwiki.com/fs0414/rfmt/7.3-error-codes-reference.html)
* [Performance and Benchmarks](https://deepwiki.com/fs0414/rfmt/7.4-performance-and-benchmarks.html)

Menu

# Configuration System

Relevant source files

* [exe/rfmt](https://github.com/fs0414/rfmt/blob/90c575e6/exe/rfmt)
* [ext/rfmt/src/config/mod.rs](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs)
* [ext/rfmt/src/logging/logger.rs](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs)
* [lib/rfmt/cli.rb](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cli.rb)
* [lib/rfmt/configuration.rb](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/configuration.rb)
* [spec/cli\_spec.rb](https://github.com/fs0414/rfmt/blob/90c575e6/spec/cli_spec.rb)
* [spec/config\_formatting\_spec.rb](https://github.com/fs0414/rfmt/blob/90c575e6/spec/config_formatting_spec.rb)
* [spec/config\_management\_spec.rb](https://github.com/fs0414/rfmt/blob/90c575e6/spec/config_management_spec.rb)
* [spec/rfmt\_spec.rb](https://github.com/fs0414/rfmt/blob/90c575e6/spec/rfmt_spec.rb)

The Configuration System manages formatting rules, file selection patterns, and parser options for rfmt. It implements a hierarchical discovery mechanism that searches for configuration files starting from the current directory upward through parent directories, then falling back to the home directory and finally to built-in defaults. The system operates across both Ruby and Rust layers: Ruby handles configuration discovery, file loading, and file filtering, while Rust applies formatting rules during code emission.

For information about how the CLI uses configuration, see [CLI Usage](https://deepwiki.com/fs0414/rfmt/3.1-cli-usage.html). For details on the formatting rules themselves, see [Formatting Engine (Emitter)](https://deepwiki.com/fs0414/rfmt/4.2-formatting-engine-(emitter).html).

## System Architecture

**Sources:** [lib/rfmt/cli.rb143-149](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cli.rb#L143-L149) [lib/rfmt/configuration.rb29-33](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/configuration.rb#L29-L33) [ext/rfmt/src/config/mod.rs104-138](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L104-L138)

## Configuration Discovery

The configuration discovery mechanism searches for configuration files in multiple locations with specific precedence rules. This allows project-specific configurations to override user-wide settings.

### Discovery Sequence

**Sources:** [ext/rfmt/src/config/mod.rs104-138](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L104-L138) [lib/rfmt/configuration.rb29-33](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/configuration.rb#L29-L33)

### File Name Precedence

The system searches for configuration files in the following order, using the first one found:

| Priority | Filename | Description |
| --- | --- | --- |
| 1 | `rfmt.yml` | Preferred modern format |
| 2 | `rfmt.yaml` | Alternative YAML extension |
| 3 | `.rfmt.yml` | Hidden file format |
| 4 | `.rfmt.yaml` | Hidden file with .yaml extension |

**Sources:** [lib/rfmt/configuration.rb21](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/configuration.rb#L21-L21) [ext/rfmt/src/config/mod.rs105](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L105-L105)

### Discovery Implementation

The Ruby-side discovery is implemented in the `Configuration` class:

```
Rfmt::Configuration.discover
  ├─ Searches CONFIG_FILES in current directory
  ├─ Returns Configuration instance if found
  └─ Falls back to new() with defaults
```

The Rust-side discovery walks the directory tree:

```
Config::discover()
  ├─ std::env::current_dir() → start_dir
  ├─ Loop: check config_files in current_dir
  ├─ current_dir.pop() → move to parent
  ├─ dirs::home_dir() → check home directory
  └─ Config::default() → fallback
```

**Sources:** [lib/rfmt/configuration.rb29-33](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/configuration.rb#L29-L33) [ext/rfmt/src/config/mod.rs104-138](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L104-L138)

## Configuration Structure

The configuration is organized into a hierarchical structure with nested sections for different aspects of the formatter's behavior.

### Top-Level Structure

**Sources:** [ext/rfmt/src/config/mod.rs4-46](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L4-L46)

### Configuration Structs

The Rust implementation defines multiple interconnected structs:

| Struct | Fields | Purpose |
| --- | --- | --- |
| `Config` | version, parser, formatting, include, exclude | Root configuration container |
| `ParserConfig` | version, error\_tolerance, encoding | Parser behavior settings |
| `FormattingConfig` | line\_length, indent\_style, indent\_width, quote\_style, style | Core formatting rules |
| `StyleConfig` | quotes, hash\_syntax, trailing\_comma | Style-specific preferences |

**Sources:** [ext/rfmt/src/config/mod.rs4-73](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L4-L73)

### Configuration Enums

**Sources:** [ext/rfmt/src/config/mod.rs55-99](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L55-L99)

## Ruby-Side Configuration Loading

The Ruby layer handles configuration discovery, loading, and file filtering through the `Rfmt::Configuration` class and `Rfmt::Config` module.

### Configuration Class

The `Rfmt::Configuration` class manages configuration lifecycle:

```
Rfmt::Configuration
  ├─ initialize(options = {})
  │   └─ load_configuration(options)
  │       ├─ deep_dup(DEFAULT_CONFIG)
  │       ├─ YAML.load_file(file) if file specified
  │       ├─ deep_merge(config, file_config)
  │       └─ validate_config!(config)
  ├─ self.discover
  │   └─ Finds first CONFIG_FILES
  ├─ files_to_format(base_path: '.')
  │   ├─ Apply include patterns
  │   ├─ Apply exclude patterns
  │   └─ Return filtered file list
  └─ formatting_config
      └─ Returns config['formatting']
```

**Sources:** [lib/rfmt/configuration.rb7-95](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/configuration.rb#L7-L95)

### Config Module API

The `Rfmt::Config` module provides utility methods for configuration management:

**Sources:** [spec/config\_management\_spec.rb9-53](https://github.com/fs0414/rfmt/blob/90c575e6/spec/config_management_spec.rb#L9-L53) [lib/rfmt/cli.rb128-139](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cli.rb#L128-L139)

### Default Configuration

The Ruby-side default configuration is defined as a constant:

**Sources:** [lib/rfmt/configuration.rb10-19](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/configuration.rb#L10-L19)

## Rust-Side Configuration Loading

The Rust layer deserializes configuration from YAML and applies validation before use in the formatting engine.

### Loading Process

**Sources:** [ext/rfmt/src/config/mod.rs141-156](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L141-L156)

### Deserialization Attributes

The Rust structs use Serde attributes for flexible YAML parsing:

| Attribute | Purpose | Example |
| --- | --- | --- |
| `#[serde(default)]` | Use Default::default() if missing | Applied to most fields |
| `#[serde(rename = "...")]` | Map YAML key to different field name | `indent_style` field |
| `#[serde(rename_all = "lowercase")]` | Convert enum variants to lowercase | `IndentStyle`, `QuoteStyle` |
| `#[serde(default = "fn")]` | Use custom default function | `default_line_length()` |

**Sources:** [ext/rfmt/src/config/mod.rs4-73](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L4-L73)

### Default Implementations

Each configuration struct implements `Default`:

```
Config::default()
  ├─ version: "1.0"
  ├─ parser: ParserConfig::default()
  ├─ formatting: FormattingConfig::default()
  ├─ include: ["**/*.rb", "**/*.rake"]
  └─ exclude: ["vendor/**/*", "tmp/**/*", "node_modules/**/*"]

ParserConfig::default()
  ├─ version: "latest"
  ├─ error_tolerance: true
  └─ encoding: "UTF-8"

FormattingConfig::default()
  ├─ line_length: 100
  ├─ indent_style: IndentStyle::Spaces
  ├─ indent_width: 2
  ├─ quote_style: QuoteStyle::Double
  └─ style: StyleConfig::default()

StyleConfig::default()
  ├─ quotes: QuoteStyle::Double
  ├─ hash_syntax: HashSyntax::Ruby19
  └─ trailing_comma: TrailingComma::Multiline
```

**Sources:** [ext/rfmt/src/config/mod.rs229-275](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L229-L275)

## Configuration Validation

Both Ruby and Rust layers validate configuration values to ensure reasonable formatting behavior.

### Ruby Validation

The `Configuration` class performs basic validation:

```
validate_config!(config)
  ├─ Check line_length > 0
  ├─ Check indent_width > 0
  └─ Raise ConfigError if invalid
```

**Sources:** [lib/rfmt/configuration.rb71-77](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/configuration.rb#L71-L77)

### Rust Validation

The `Config::validate()` method enforces stricter bounds:

| Parameter | Minimum | Maximum | Default | Error Message |
| --- | --- | --- | --- | --- |
| `line_length` | 40 | 500 | 100 | "line\_length must be between 40 and 500" |
| `indent_width` | 1 | 8 | 2 | "indent\_width must be between 1 and 8" |

**Sources:** [ext/rfmt/src/config/mod.rs159-181](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L159-L181)

### Validation Tests

The validation logic is thoroughly tested:

```
test_validate_line_length_too_small
  └─ line_length: 30 → ConfigError

test_validate_line_length_too_large
  └─ line_length: 600 → ConfigError

test_validate_indent_width
  └─ indent_width: 10 → ConfigError
```

**Sources:** [ext/rfmt/src/config/mod.rs323-373](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L323-L373)

## File Filtering

The configuration system provides include/exclude patterns for file discovery, implemented differently in Ruby and Rust.

### Ruby File Filtering

The `Configuration#files_to_format` method applies glob patterns:

```
files_to_format(base_path: '.')
  ├─ include_patterns.flat_map { Dir.glob(pattern) }
  ├─ exclude_patterns.flat_map { Dir.glob(pattern) }
  └─ (included_files - excluded_files).select { |f| File.file?(f) }
```

**Sources:** [lib/rfmt/configuration.rb36-44](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/configuration.rb#L36-L44)

### Rust File Filtering

The Rust implementation uses the `globset` crate for pattern matching:

**Sources:** [ext/rfmt/src/config/mod.rs193-226](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L193-L226)

### Pattern Precedence

Exclude patterns take precedence over include patterns:

```
1. Check exclude patterns first
   └─ If match found → return false (excluded)
2. Check include patterns
   └─ If match found → return true (included)
   └─ No match → return false (not included)
```

**Sources:** [ext/rfmt/src/config/mod.rs199-223](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L199-L223)

### Default Patterns

| Pattern Type | Patterns |
| --- | --- |
| Include | `**/*.rb`, `**/*.rake` |
| Exclude | `vendor/**/*`, `tmp/**/*`, `node_modules/**/*` |

**Sources:** [ext/rfmt/src/config/mod.rs235-241](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L235-L241) [lib/rfmt/configuration.rb17-18](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/configuration.rb#L17-L18)

## CLI Configuration Integration

The CLI integrates configuration through multiple mechanisms:

### Configuration Options

**Sources:** [lib/rfmt/cli.rb47-149](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cli.rb#L47-L149)

### Configuration Commands

The CLI provides configuration management commands:

| Command | Description | Implementation |
| --- | --- | --- |
| `rfmt init` | Create configuration file | `Rfmt::Config.init(path, force: options[:force])` |
| `rfmt config` | Display current configuration | `JSON.pretty_generate(config.config)` |

**Sources:** [lib/rfmt/cli.rb115-139](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cli.rb#L115-L139)

### Init Command Flow

```
rfmt init [--path .rfmt.yml] [--force]
  ├─ config_file = options[:path] || '.rfmt.yml'
  ├─ Rfmt::Config.init(config_file, force: options[:force])
  │   ├─ Check if file exists
  │   ├─ If exists && !force → return false
  │   └─ Write DEFAULT_CONFIG to file
  ├─ Success → "Created {file}" (green)
  └─ Exists → "already exists. Use --force" (yellow)
```

**Sources:** [lib/rfmt/cli.rb125-139](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cli.rb#L125-L139)

## Environment Variable Configuration

The logging system uses environment variables for runtime configuration:

| Variable | Purpose | Values | Default |
| --- | --- | --- | --- |
| `DEBUG` | Enable debug mode | any value | off |
| `RFMT_DEBUG` | rfmt-specific debug | any value | off |
| `RUST_LOG` | Rust log level | any value | off |
| `RFMT_LOG` | Explicit log level | trace, debug, info, warn, error | warn (or info if debug mode) |

**Sources:** [ext/rfmt/src/logging/logger.rs24-44](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs#L24-L44)

## Configuration Application

The configuration flows from discovery through to formatting:

**Sources:** [lib/rfmt/cli.rb62-101](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cli.rb#L62-L101) [ext/rfmt/src/config/mod.rs1-276](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L1-L276)

Dismiss

Refresh this wiki

Enter email to refresh

### On this page

* [Configuration System](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#configuration-system)
* [System Architecture](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#system-architecture)
* [Configuration Discovery](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#configuration-discovery)
* [Discovery Sequence](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#discovery-sequence)
* [File Name Precedence](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#file-name-precedence)
* [Discovery Implementation](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#discovery-implementation)
* [Configuration Structure](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#configuration-structure)
* [Top-Level Structure](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#top-level-structure)
* [Configuration Structs](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#configuration-structs)
* [Configuration Enums](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#configuration-enums)
* [Ruby-Side Configuration Loading](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#ruby-side-configuration-loading)
* [Configuration Class](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#configuration-class)
* [Config Module API](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#config-module-api)
* [Default Configuration](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#default-configuration)
* [Rust-Side Configuration Loading](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#rust-side-configuration-loading)
* [Loading Process](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#loading-process)
* [Deserialization Attributes](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#deserialization-attributes)
* [Default Implementations](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#default-implementations)
* [Configuration Validation](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#configuration-validation)
* [Ruby Validation](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#ruby-validation)
* [Rust Validation](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#rust-validation)
* [Validation Tests](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#validation-tests)
* [File Filtering](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#file-filtering)
* [Ruby File Filtering](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#ruby-file-filtering)
* [Rust File Filtering](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#rust-file-filtering)
* [Pattern Precedence](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#pattern-precedence)
* [Default Patterns](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#default-patterns)
* [CLI Configuration Integration](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#cli-configuration-integration)
* [Configuration Options](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#configuration-options)
* [Configuration Commands](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#configuration-commands)
* [Init Command Flow](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#init-command-flow)
* [Environment Variable Configuration](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#environment-variable-configuration)
* [Configuration Application](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html#configuration-application)
