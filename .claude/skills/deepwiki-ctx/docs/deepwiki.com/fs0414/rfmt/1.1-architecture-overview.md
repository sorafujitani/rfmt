---
title: "Architecture Overview | fs0414/rfmt | DeepWiki"
source_url: "https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview"
fetched_at: "2026-01-13T10:53:43.101777+00:00"
---



Loading...

Index your code with Devin

[DeepWiki](https://deepwiki.com/)

[DeepWiki](https://deepwiki.com/)

[fs0414/rfmt](https://github.com/fs0414/rfmt "Open repository")

Index your code with

Devin

Edit WikiShare

Loading...

Last indexed: 3 January 2026 ([90c575](https://github.com/fs0414/rfmt/commits/90c575e6))

* [Overview](https://deepwiki.com/fs0414/rfmt/1-overview.html)
* [Architecture Overview](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html)
* [Key Concepts](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html)
* [Getting Started](https://deepwiki.com/fs0414/rfmt/2-getting-started.html)
* [Installation](https://deepwiki.com/fs0414/rfmt/2.1-installation.html)
* [Configuration](https://deepwiki.com/fs0414/rfmt/2.2-configuration.html)
* [User Guides](https://deepwiki.com/fs0414/rfmt/3-user-guides.html)
* [CLI Usage](https://deepwiki.com/fs0414/rfmt/3.1-cli-usage.html)
* [Ruby API](https://deepwiki.com/fs0414/rfmt/3.2-ruby-api.html)
* [Editor Integration](https://deepwiki.com/fs0414/rfmt/3.3-editor-integration.html)
* [Core Systems](https://deepwiki.com/fs0414/rfmt/4-core-systems.html)
* [AST Representation](https://deepwiki.com/fs0414/rfmt/4.1-ast-representation.html)
* [Formatting Engine (Emitter)](https://deepwiki.com/fs0414/rfmt/4.2-formatting-engine-(emitter).html)
* [Parser Integration (PrismBridge)](https://deepwiki.com/fs0414/rfmt/4.3-parser-integration-(prismbridge).html)
* [Configuration System](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html)
* [Caching System](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html)
* [Logging System](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html)
* [Formatting Behavior](https://deepwiki.com/fs0414/rfmt/5-formatting-behavior.html)
* [Control Flow Formatting](https://deepwiki.com/fs0414/rfmt/5.1-control-flow-formatting.html)
* [Exception Handling Formatting](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html)
* [Lambda and Block Formatting](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html)
* [Development](https://deepwiki.com/fs0414/rfmt/6-development.html)
* [Building from Source](https://deepwiki.com/fs0414/rfmt/6.1-building-from-source.html)
* [Testing](https://deepwiki.com/fs0414/rfmt/6.2-testing.html)
* [Release Process](https://deepwiki.com/fs0414/rfmt/6.3-release-process.html)
* [Reference](https://deepwiki.com/fs0414/rfmt/7-reference.html)
* [Node Types Reference](https://deepwiki.com/fs0414/rfmt/7.1-node-types-reference.html)
* [Configuration Options Reference](https://deepwiki.com/fs0414/rfmt/7.2-configuration-options-reference.html)
* [Error Codes Reference](https://deepwiki.com/fs0414/rfmt/7.3-error-codes-reference.html)
* [Performance and Benchmarks](https://deepwiki.com/fs0414/rfmt/7.4-performance-and-benchmarks.html)

Menu

# Architecture Overview

Relevant source files

* [.rubocop.yml](https://github.com/fs0414/rfmt/blob/90c575e6/.rubocop.yml)
* [Cargo.lock](https://github.com/fs0414/rfmt/blob/90c575e6/Cargo.lock)
* [ext/rfmt/Cargo.toml](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/Cargo.toml)
* [ext/rfmt/src/ast/mod.rs](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs)
* [ext/rfmt/src/emitter/mod.rs](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs)
* [lib/rfmt/prism\_bridge.rb](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb)
* [lib/rfmt/prism\_node\_extractor.rb](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_node_extractor.rb)
* [rfmt.gemspec](https://github.com/fs0414/rfmt/blob/90c575e6/rfmt.gemspec)
* [spec/spec\_helper.rb](https://github.com/fs0414/rfmt/blob/90c575e6/spec/spec_helper.rb)

## Purpose and Scope

This page describes the fundamental architecture of `rfmt`, focusing on the hybrid Ruby-Rust design, the FFI boundary mechanism, and how data flows through the system from Ruby source code to formatted output. For detailed information about specific subsystems, see [Key Concepts](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html) for terminology and component definitions, [Parser Integration](https://deepwiki.com/fs0414/rfmt/4.3-parser-integration-(prismbridge).html) for Prism bridge details, and [Formatting Engine](https://deepwiki.com/fs0414/rfmt/4.2-formatting-engine-(emitter).html) for the Rust emitter implementation.

## Architectural Philosophy

`rfmt` employs a hybrid architecture that divides responsibilities across two languages to optimize for both ease of distribution and runtime performance:

* **Ruby Frontend**: Handles user interfaces, file I/O, configuration discovery, and AST parsing via the Prism parser
* **Rust Core**: Performs computationally intensive formatting operations with minimal overhead
* **FFI Boundary**: Enables seamless communication between Ruby and Rust through Magnus and rb-sys

This separation allows `rfmt` to distribute as a standard RubyGem while achieving formatting performance comparable to native Rust tools.

**Sources**: [ext/rfmt/Cargo.toml14-16](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/Cargo.toml#L14-L16) [rfmt.gemspec40](https://github.com/fs0414/rfmt/blob/90c575e6/rfmt.gemspec#L40-L40) [lib/rfmt/prism\_bridge.rb8-10](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L8-L10)

## System Architecture and Language Boundaries

**Ruby Layer Responsibilities**:

* Command-line interface implementation via `Rfmt::CLI`
* File discovery and parallel processing orchestration
* Configuration file loading and validation
* Cache management for incremental formatting
* AST generation through Prism parser integration
* AST serialization for FFI transfer

**Rust Layer Responsibilities**:

* AST deserialization from JSON format
* Application of formatting rules (indentation, line length, quote style)
* Comment collection and reinsertion to preserve documentation
* Source code generation from formatted AST

**Sources**: [ext/rfmt/Cargo.toml14-16](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/Cargo.toml#L14-L16) [lib/rfmt/prism\_bridge.rb1-26](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L1-L26) [ext/rfmt/src/emitter/mod.rs1-5](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L1-L5) [ext/rfmt/src/ast/mod.rs1-14](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L1-L14)

## FFI Boundary Mechanism

The communication between Ruby and Rust occurs through the Magnus framework, which provides safe Ruby-Rust interop:

| Component | Role | Location |
| --- | --- | --- |
| `magnus` | High-level Ruby bindings for Rust | [ext/rfmt/Cargo.toml15](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/Cargo.toml#L15-L15) |
| `rb-sys` | Low-level Ruby C API bindings | [ext/rfmt/Cargo.toml16](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/Cargo.toml#L16-L16) |
| `rb-sys-build` | Compile-time native extension builder | [Cargo.lock1160-1162](https://github.com/fs0414/rfmt/blob/90c575e6/Cargo.lock#L1160-L1162) |

The FFI boundary handles:

* **Type Conversion**: JSON serialization for AST transfer (Ruby â†’ Rust)
* **Memory Safety**: Magnus ensures proper Ruby object lifetime management
* **Error Handling**: Rust errors converted to Ruby exceptions
* **String Encoding**: UTF-8 string handling across the boundary

The choice of JSON as the serialization format provides:

* Language-agnostic data representation
* Easy debugging and introspection
* Minimal FFI overhead compared to direct struct passing
* Future-proof protocol for API evolution

**Sources**: [ext/rfmt/Cargo.toml14-22](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/Cargo.toml#L14-L22) [lib/rfmt/prism\_bridge.rb59-84](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L59-L84)

## Data Flow Pipeline

**Pipeline Stages**:

1. **Input Stage**: Read Ruby source file and discover configuration
2. **Ruby Processing**:
   * Parse source with Prism into native Ruby AST
   * Extract metadata via `PrismNodeExtractor` ([lib/rfmt/prism\_node\_extractor.rb11-114](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_node_extractor.rb#L11-L114))
   * Serialize AST and comments to JSON
3. **FFI Transfer**: Marshal JSON through Magnus boundary
4. **Rust Processing**:
   * Deserialize JSON to `Node` structs ([ext/rfmt/src/ast/mod.rs7-14](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L7-L14))
   * Collect all comments for position-aware reinsertion ([ext/rfmt/src/emitter/mod.rs85-91](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L85-L91))
   * Dispatch nodes to specialized formatting methods ([ext/rfmt/src/emitter/mod.rs149-171](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L149-L171))
   * Reinsert comments at appropriate locations ([ext/rfmt/src/emitter/mod.rs94-123](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L94-L123))
   * Generate formatted source string
5. **Output Stage**: Return formatted code and update cache

**Sources**: [lib/rfmt/prism\_bridge.rb20-26](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L20-L26) [ext/rfmt/src/emitter/mod.rs44-62](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L44-L62) [ext/rfmt/src/ast/mod.rs1-14](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L1-L14)

## Core Components and Their Interactions

### Ruby Frontend Components

**Component Descriptions**:

| Component | Responsibility | Key Methods |
| --- | --- | --- |
| `Rfmt::CLI` | Command-line interface, orchestrates formatting | `run`, `format_files`, `check_files` |
| `Rfmt::PrismBridge` | AST parsing and serialization | `parse`, `convert_node`, `serialize_ast_with_comments` |
| `PrismNodeExtractor` | Extract metadata from Prism nodes | `extract_class_or_module_name`, `extract_parameter_count` |
| `Rfmt::Config` | Configuration discovery and loading | `load`, `discover`, `validate` |
| `Rfmt::Cache` | File hash caching for incremental formatting | `load`, `formatted?`, `mark_formatted` |

**Sources**: [lib/rfmt/prism\_bridge.rb8-26](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L8-L26) [lib/rfmt/prism\_node\_extractor.rb4-7](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_node_extractor.rb#L4-L7)

### Rust Core Components

**Core Rust Structures**:

| Structure | Definition | Purpose |
| --- | --- | --- |
| `Node` | [ext/rfmt/src/ast/mod.rs7-14](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L7-L14) | Internal AST representation with type, location, children, metadata |
| `NodeType` | [ext/rfmt/src/ast/mod.rs28-184](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L28-L184) | Enum of 80+ Ruby syntax node types |
| `Location` | [ext/rfmt/src/ast/mod.rs17-25](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L17-L25) | Source position tracking (line, column, byte offset) |
| `Comment` | [ext/rfmt/src/ast/mod.rs308-314](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L308-L314) | Comment text with position and type |
| `Emitter` | [ext/rfmt/src/emitter/mod.rs14-20](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L14-L20) | Formatting engine with config, source buffer, comment tracking |
| `Config` | [ext/rfmt/src/config/](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/) | Formatting rules (indent width, line length, quote style) |

**Sources**: [ext/rfmt/src/ast/mod.rs7-184](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/ast/mod.rs#L7-L184) [ext/rfmt/src/emitter/mod.rs14-20](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L14-L20)

## Node Dispatch and Formatting Strategy

The `Emitter` uses a dispatch pattern to route different node types to specialized formatting methods:

**Formatting Strategies**:

1. **Structured Formatting**: Reconstructs syntax from AST metadata

   * Used for well-defined constructs (classes, methods, control flow)
   * Applies consistent indentation and spacing rules
   * Example: [ext/rfmt/src/emitter/mod.rs230-274](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L230-L274) for classes
2. **Source Extraction**: Extracts original source text

   * Used for complex syntax (method parameters with defaults, lambdas)
   * Preserves original formatting where reconstruction is difficult
   * Example: [ext/rfmt/src/emitter/mod.rs541-547](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L541-L547) for lambdas
3. **Hybrid Approach**: Combines both strategies

   * Structures outer syntax, extracts inner details
   * Example: Methods format structure but extract parameters [ext/rfmt/src/emitter/mod.rs342-358](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L342-L358)

**Sources**: [ext/rfmt/src/emitter/mod.rs149-171](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L149-L171) [ext/rfmt/src/emitter/mod.rs230-385](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L230-L385)

## Comment Preservation Architecture

Comment preservation is critical for maintaining code documentation. The system tracks comments through three phases:

**Phase 1: Collection**

* All comments extracted during Prism parsing ([lib/rfmt/prism\_bridge.rb64-78](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L64-L78))
* Comments recursively collected from entire AST ([ext/rfmt/src/emitter/mod.rs85-91](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L85-L91))

**Phase 2: Position Tracking**

* Comments sorted by line number
* Tracked by array indices to mark as emitted
* Three position types: leading, trailing, inline

**Phase 3: Strategic Reinsertion**

* **Leading comments**: Emitted before nodes at matching line numbers ([ext/rfmt/src/emitter/mod.rs94-123](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L94-L123))
* **Trailing comments**: Emitted on same line as code ([ext/rfmt/src/emitter/mod.rs126-146](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L126-L146))
* **Remaining comments**: Emitted at end to prevent loss ([ext/rfmt/src/emitter/mod.rs65-83](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L65-L83))

This ensures comments never disappear during formatting, even if their original position is ambiguous after AST transformation.

**Sources**: [ext/rfmt/src/emitter/mod.rs85-146](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L85-L146) [lib/rfmt/prism\_bridge.rb64-84](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L64-L84)

## Build and Distribution Model

The gem distribution includes pre-compiled native extensions for common platforms:

| Platform | Binary Location | Build System |
| --- | --- | --- |
| Linux x86\_64 | `lib/rfmt/*.so` | `rb-sys-build` via Rust cross-compilation |
| macOS ARM64 | `lib/rfmt/*.bundle` | Native build on Apple Silicon |
| macOS x86\_64 | `lib/rfmt/*.bundle` | Cross-compilation or Rosetta |
| Windows x64 | `lib/rfmt/*.dll` | MinGW cross-compilation |

The build process:

1. `rake compile` triggers `rb-sys-build` ([rfmt.gemspec36](https://github.com/fs0414/rfmt/blob/90c575e6/rfmt.gemspec#L36-L36))
2. Rust code compiled to native library via Cargo
3. Magnus generates Ruby C extension wrapper
4. Extension linked into gem structure

This allows installation via standard `gem install rfmt` without requiring Rust toolchain on end-user machines, except for platforms without pre-built binaries.

**Sources**: [rfmt.gemspec36-40](https://github.com/fs0414/rfmt/blob/90c575e6/rfmt.gemspec#L36-L40) [ext/rfmt/Cargo.toml10-11](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/Cargo.toml#L10-L11)

## Performance Characteristics

The architecture achieves high performance through:

* **Rust Core**: Zero-cost abstractions, no garbage collection pauses during formatting
* **Minimal FFI Overhead**: Single boundary crossing per file with JSON payload
* **Parallel Processing**: Ruby's thread pool processes multiple files concurrently
* **Caching**: File hash comparison skips unchanged files
* **Source Extraction**: Avoids expensive string manipulation for complex syntax

Bottlenecks and tradeoffs:

* JSON serialization adds ~5-10% overhead vs. direct struct passing
* Comment reinsertion requires full AST traversal twice (collect + emit)
* Generic fallback preserves correctness at cost of customization

**Sources**: [ext/rfmt/src/emitter/mod.rs85-91](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L85-L91) [lib/rfmt/prism\_bridge.rb59-84](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L59-L84)

Dismiss

Refresh this wiki

Enter email to refresh

### On this page

* [Architecture Overview](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html#architecture-overview)
* [Purpose and Scope](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html#purpose-and-scope)
* [Architectural Philosophy](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html#architectural-philosophy)
* [System Architecture and Language Boundaries](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html#system-architecture-and-language-boundaries)
* [FFI Boundary Mechanism](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html#ffi-boundary-mechanism)
* [Data Flow Pipeline](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html#data-flow-pipeline)
* [Core Components and Their Interactions](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html#core-components-and-their-interactions)
* [Ruby Frontend Components](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html#ruby-frontend-components)
* [Rust Core Components](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html#rust-core-components)
* [Node Dispatch and Formatting Strategy](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html#node-dispatch-and-formatting-strategy)
* [Comment Preservation Architecture](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html#comment-preservation-architecture)
* [Build and Distribution Model](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html#build-and-distribution-model)
* [Performance Characteristics](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html#performance-characteristics)
