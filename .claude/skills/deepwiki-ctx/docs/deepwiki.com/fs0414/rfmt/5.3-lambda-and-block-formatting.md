---
title: "Lambda and Block Formatting | fs0414/rfmt | DeepWiki"
source_url: "https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting"
fetched_at: "2026-01-13T10:53:43.101777+00:00"
---



Loading...

Index your code with Devin

[DeepWiki](https://deepwiki.com/)

[DeepWiki](https://deepwiki.com/)

[fs0414/rfmt](https://github.com/fs0414/rfmt "Open repository")

Index your code with

Devin

Edit WikiShare

Loading...

Last indexed: 3 January 2026 ([90c575](https://github.com/fs0414/rfmt/commits/90c575e6))

* [Overview](https://deepwiki.com/fs0414/rfmt/1-overview.html)
* [Architecture Overview](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html)
* [Key Concepts](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html)
* [Getting Started](https://deepwiki.com/fs0414/rfmt/2-getting-started.html)
* [Installation](https://deepwiki.com/fs0414/rfmt/2.1-installation.html)
* [Configuration](https://deepwiki.com/fs0414/rfmt/2.2-configuration.html)
* [User Guides](https://deepwiki.com/fs0414/rfmt/3-user-guides.html)
* [CLI Usage](https://deepwiki.com/fs0414/rfmt/3.1-cli-usage.html)
* [Ruby API](https://deepwiki.com/fs0414/rfmt/3.2-ruby-api.html)
* [Editor Integration](https://deepwiki.com/fs0414/rfmt/3.3-editor-integration.html)
* [Core Systems](https://deepwiki.com/fs0414/rfmt/4-core-systems.html)
* [AST Representation](https://deepwiki.com/fs0414/rfmt/4.1-ast-representation.html)
* [Formatting Engine (Emitter)](https://deepwiki.com/fs0414/rfmt/4.2-formatting-engine-(emitter).html)
* [Parser Integration (PrismBridge)](https://deepwiki.com/fs0414/rfmt/4.3-parser-integration-(prismbridge).html)
* [Configuration System](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html)
* [Caching System](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html)
* [Logging System](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html)
* [Formatting Behavior](https://deepwiki.com/fs0414/rfmt/5-formatting-behavior.html)
* [Control Flow Formatting](https://deepwiki.com/fs0414/rfmt/5.1-control-flow-formatting.html)
* [Exception Handling Formatting](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html)
* [Lambda and Block Formatting](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html)
* [Development](https://deepwiki.com/fs0414/rfmt/6-development.html)
* [Building from Source](https://deepwiki.com/fs0414/rfmt/6.1-building-from-source.html)
* [Testing](https://deepwiki.com/fs0414/rfmt/6.2-testing.html)
* [Release Process](https://deepwiki.com/fs0414/rfmt/6.3-release-process.html)
* [Reference](https://deepwiki.com/fs0414/rfmt/7-reference.html)
* [Node Types Reference](https://deepwiki.com/fs0414/rfmt/7.1-node-types-reference.html)
* [Configuration Options Reference](https://deepwiki.com/fs0414/rfmt/7.2-configuration-options-reference.html)
* [Error Codes Reference](https://deepwiki.com/fs0414/rfmt/7.3-error-codes-reference.html)
* [Performance and Benchmarks](https://deepwiki.com/fs0414/rfmt/7.4-performance-and-benchmarks.html)

Menu

# Lambda and Block Formatting

Relevant source files

* [ext/rfmt/src/emitter/mod.rs](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs)
* [lib/rfmt/prism\_bridge.rb](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb)
* [lib/rfmt/prism\_node\_extractor.rb](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_node_extractor.rb)
* [spec/ensure\_formatting\_spec.rb](https://github.com/fs0414/rfmt/blob/90c575e6/spec/ensure_formatting_spec.rb)
* [spec/lambda\_formatting\_spec.rb](https://github.com/fs0414/rfmt/blob/90c575e6/spec/lambda_formatting_spec.rb)

This page documents how `rfmt` formats Ruby lambda expressions and blocks. It covers stabby lambda syntax (`->`), traditional `lambda` keyword, block styles (`do...end` vs `{ }`), block parameters, and how blocks are formatted when attached to method calls.

For control flow constructs like `if` and `case`, see [5.1](https://deepwiki.com/fs0414/rfmt/5.1-control-flow-formatting.html). For exception handling constructs like `begin` and `rescue`, see [5.2](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html).

## Overview

`rfmt` preserves the original block style (braces vs do...end) and lambda syntax to maintain developer intent. The formatting engine detects the style from source code and applies appropriate indentation rules based on whether the block is inline or multiline.

**Sources:** [ext/rfmt/src/emitter/mod.rs6-11](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L6-L11) [ext/rfmt/src/emitter/mod.rs162](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L162-L162) [ext/rfmt/src/emitter/mod.rs540-547](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L540-L547)

## Block Style Representation

The Rust emitter uses a `BlockStyle` enum to distinguish between the two primary block syntaxes in Ruby.

**Sources:** [ext/rfmt/src/emitter/mod.rs6-11](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L6-L11) [ext/rfmt/src/emitter/mod.rs859-873](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L859-L873)

## AST Structure for Lambda and Block Nodes

### LambdaNode Structure

**Sources:** [lib/rfmt/prism\_bridge.rb183-189](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L183-L189) [ext/rfmt/src/emitter/mod.rs540-547](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L540-L547)

### BlockNode Structure

**Sources:** [lib/rfmt/prism\_bridge.rb168-174](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L168-L174) [ext/rfmt/src/emitter/mod.rs825-857](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L825-L857)

## Lambda Formatting

### emit\_lambda Implementation

The `emit_lambda` method uses source extraction to preserve the original lambda syntax because of the multiple valid syntactic forms:

| Syntax Form | Example | Description |
| --- | --- | --- |
| Stabby lambda, braces | `-> { 42 }` | Inline single expression |
| Stabby lambda, do...end | `-> do ... end` | Multi-line block |
| Stabby lambda with params | `->(x, y) { x + y }` | Parameters in parentheses |
| Lambda keyword | `lambda { ... }` | Traditional syntax |
| Lambda with params | `lambda { |x| x * 2 }` | Parameters in pipes |

The complexity of reconstructing these forms correctly leads to the source extraction strategy:

**Sources:** [ext/rfmt/src/emitter/mod.rs540-547](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L540-L547) [spec/lambda\_formatting\_spec.rb1-17](https://github.com/fs0414/rfmt/blob/90c575e6/spec/lambda_formatting_spec.rb#L1-L17)

### Rails Scope Pattern

A common pattern in Rails is using lambdas for scopes. The formatter preserves this style:

**Sources:** [spec/lambda\_formatting\_spec.rb12-16](https://github.com/fs0414/rfmt/blob/90c575e6/spec/lambda_formatting_spec.rb#L12-L16)

## Block Parameter Formatting

### emit\_block\_parameters Method

Block parameters are extracted from source and formatted as part of the block header:

The implementation searches only the first line of the block to locate parameter definitions:

**Sources:** [ext/rfmt/src/emitter/mod.rs961-985](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L961-L985)

## Method Calls with Blocks

### emit\_call Block Detection

The `emit_call` method handles blocks specially by detecting if the last child is a `BlockNode`:

**Sources:** [ext/rfmt/src/emitter/mod.rs825-857](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L825-L857)

### Block Style Detection Strategy

The `detect_block_style` method examines the first character at the block's start offset to determine style:

**Sources:** [ext/rfmt/src/emitter/mod.rs859-873](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L859-L873)

## Multiline vs Inline Block Formatting

### do...end Blocks (Always Multiline)

Example formatting:

**Sources:** [ext/rfmt/src/emitter/mod.rs897-923](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L897-L923)

### Brace Blocks (Inline or Multiline)

Brace blocks are formatted based on whether they span multiple lines:

**Sources:** [ext/rfmt/src/emitter/mod.rs925-959](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L925-L959)

### Inline Brace Block Example

For single-line brace blocks, the formatter extracts directly from source to preserve exact spacing:

This preserves developer formatting choices for simple blocks like:

**Sources:** [ext/rfmt/src/emitter/mod.rs947-956](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L947-L956)

## Call Without Block Emission

The `emit_call_without_block` method extracts the method call portion excluding the block:

This extracts text from the call node's start to the block node's start, ensuring the receiver, method name, and arguments are included but the block is omitted.

**Sources:** [ext/rfmt/src/emitter/mod.rs875-895](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L875-L895)

## Complete Formatting Flow

**Sources:** [lib/rfmt/prism\_bridge.rb86-98](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L86-L98) [lib/rfmt/prism\_bridge.rb168-174](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L168-L174) [lib/rfmt/prism\_bridge.rb183-189](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L183-L189) [ext/rfmt/src/emitter/mod.rs148-171](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L148-L171) [ext/rfmt/src/emitter/mod.rs540-547](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L540-L547) [ext/rfmt/src/emitter/mod.rs825-857](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L825-L857)

## Style Preservation Philosophy

The formatting engine employs a **source extraction strategy** for lambda and block syntax to preserve developer intent. This approach is necessary because:

| Construct | Variation Count | Examples |
| --- | --- | --- |
| Lambda syntax | 2 forms | `->` vs `lambda` |
| Block delimiters | 2 forms | `do...end` vs `{ }` |
| Parameter syntax | 2 forms | `->(x)` vs `|x|` |
| Inline vs multiline | 2 forms | Affects readability differently |

Rather than imposing an opinionated style, `rfmt` detects and preserves the original form, applying only structural formatting like indentation. This philosophy aligns with the project's goal of minimal configuration and respecting existing codebases.

**Sources:** [ext/rfmt/src/emitter/mod.rs540-547](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L540-L547) [ext/rfmt/src/emitter/mod.rs859-873](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L859-L873) [ext/rfmt/src/emitter/mod.rs987-1001](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L987-L1001)

Dismiss

Refresh this wiki

Enter email to refresh

### On this page

* [Lambda and Block Formatting](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#lambda-and-block-formatting)
* [Overview](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#overview)
* [Block Style Representation](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#block-style-representation)
* [AST Structure for Lambda and Block Nodes](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#ast-structure-for-lambda-and-block-nodes)
* [LambdaNode Structure](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#lambdanode-structure)
* [BlockNode Structure](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#blocknode-structure)
* [Lambda Formatting](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#lambda-formatting)
* [emit\_lambda Implementation](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#emit_lambda-implementation)
* [Rails Scope Pattern](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#rails-scope-pattern)
* [Block Parameter Formatting](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#block-parameter-formatting)
* [emit\_block\_parameters Method](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#emit_block_parameters-method)
* [Method Calls with Blocks](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#method-calls-with-blocks)
* [emit\_call Block Detection](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#emit_call-block-detection)
* [Block Style Detection Strategy](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#block-style-detection-strategy)
* [Multiline vs Inline Block Formatting](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#multiline-vs-inline-block-formatting)
* [do...end Blocks (Always Multiline)](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#doend-blocks-always-multiline)
* [Brace Blocks (Inline or Multiline)](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#brace-blocks-inline-or-multiline)
* [Inline Brace Block Example](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#inline-brace-block-example)
* [Call Without Block Emission](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#call-without-block-emission)
* [Complete Formatting Flow](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#complete-formatting-flow)
* [Style Preservation Philosophy](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html#style-preservation-philosophy)
