---
title: "Logging System | fs0414/rfmt | DeepWiki"
source_url: "https://deepwiki.com/fs0414/rfmt/4.6-logging-system"
fetched_at: "2026-01-13T10:53:43.101777+00:00"
---



Loading...

Index your code with Devin

[DeepWiki](https://deepwiki.com/)

[DeepWiki](https://deepwiki.com/)

[fs0414/rfmt](https://github.com/fs0414/rfmt "Open repository")

Index your code with

Devin

Edit WikiShare

Loading...

Last indexed: 3 January 2026 ([90c575](https://github.com/fs0414/rfmt/commits/90c575e6))

* [Overview](https://deepwiki.com/fs0414/rfmt/1-overview.html)
* [Architecture Overview](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html)
* [Key Concepts](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html)
* [Getting Started](https://deepwiki.com/fs0414/rfmt/2-getting-started.html)
* [Installation](https://deepwiki.com/fs0414/rfmt/2.1-installation.html)
* [Configuration](https://deepwiki.com/fs0414/rfmt/2.2-configuration.html)
* [User Guides](https://deepwiki.com/fs0414/rfmt/3-user-guides.html)
* [CLI Usage](https://deepwiki.com/fs0414/rfmt/3.1-cli-usage.html)
* [Ruby API](https://deepwiki.com/fs0414/rfmt/3.2-ruby-api.html)
* [Editor Integration](https://deepwiki.com/fs0414/rfmt/3.3-editor-integration.html)
* [Core Systems](https://deepwiki.com/fs0414/rfmt/4-core-systems.html)
* [AST Representation](https://deepwiki.com/fs0414/rfmt/4.1-ast-representation.html)
* [Formatting Engine (Emitter)](https://deepwiki.com/fs0414/rfmt/4.2-formatting-engine-(emitter).html)
* [Parser Integration (PrismBridge)](https://deepwiki.com/fs0414/rfmt/4.3-parser-integration-(prismbridge).html)
* [Configuration System](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html)
* [Caching System](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html)
* [Logging System](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html)
* [Formatting Behavior](https://deepwiki.com/fs0414/rfmt/5-formatting-behavior.html)
* [Control Flow Formatting](https://deepwiki.com/fs0414/rfmt/5.1-control-flow-formatting.html)
* [Exception Handling Formatting](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html)
* [Lambda and Block Formatting](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html)
* [Development](https://deepwiki.com/fs0414/rfmt/6-development.html)
* [Building from Source](https://deepwiki.com/fs0414/rfmt/6.1-building-from-source.html)
* [Testing](https://deepwiki.com/fs0414/rfmt/6.2-testing.html)
* [Release Process](https://deepwiki.com/fs0414/rfmt/6.3-release-process.html)
* [Reference](https://deepwiki.com/fs0414/rfmt/7-reference.html)
* [Node Types Reference](https://deepwiki.com/fs0414/rfmt/7.1-node-types-reference.html)
* [Configuration Options Reference](https://deepwiki.com/fs0414/rfmt/7.2-configuration-options-reference.html)
* [Error Codes Reference](https://deepwiki.com/fs0414/rfmt/7.3-error-codes-reference.html)
* [Performance and Benchmarks](https://deepwiki.com/fs0414/rfmt/7.4-performance-and-benchmarks.html)

Menu

# Logging System

Relevant source files

* [docs/user\_guide.ja.md](https://github.com/fs0414/rfmt/blob/90c575e6/docs/user_guide.ja.md)
* [docs/user\_guide.md](https://github.com/fs0414/rfmt/blob/90c575e6/docs/user_guide.md)
* [ext/rfmt/src/config/mod.rs](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs)
* [ext/rfmt/src/logging/logger.rs](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs)
* [spec/config\_formatting\_spec.rb](https://github.com/fs0414/rfmt/blob/90c575e6/spec/config_formatting_spec.rb)

## Purpose and Scope

The Logging System provides diagnostic and debugging capabilities for rfmt's Rust core. It implements a custom logger (`RfmtLogger`) that integrates with Rust's standard `log` facade, enabling controlled visibility into the formatting engine's internal operations. This system is primarily used during development and troubleshooting, with production deployments running at reduced verbosity to minimize overhead.

For configuration file discovery and validation logging, see [Configuration System](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html). For CLI-level diagnostic output and error handling, see [CLI Usage](https://deepwiki.com/fs0414/rfmt/3.1-cli-usage.html).

**Sources:** [ext/rfmt/src/logging/logger.rs1-73](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs#L1-L73) [docs/user\_guide.md428-456](https://github.com/fs0414/rfmt/blob/90c575e6/docs/user_guide.md#L428-L456)

---

## Architecture Overview

The logging system operates at the FFI boundary between Ruby and Rust, with initialization controlled from Ruby but message generation occurring entirely in Rust:

**Sources:** [ext/rfmt/src/logging/logger.rs5-44](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs#L5-L44) [docs/user\_guide.md430-450](https://github.com/fs0414/rfmt/blob/90c575e6/docs/user_guide.md#L430-L450)

---

## RfmtLogger Implementation

### Core Structure

The `RfmtLogger` struct implements Rust's `log::Log` trait to integrate with the standard logging facade:

| Field | Type | Purpose |
| --- | --- | --- |
| `level` | `LevelFilter` | Maximum log level to emit |
| `output` | `Mutex<Box<dyn Write + Send>>` | Thread-safe output destination (default: stderr) |

**Sources:** [ext/rfmt/src/logging/logger.rs5-8](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs#L5-L8)

### Initialization Flow

The `RfmtLogger::init()` method is called once when the Rust extension loads:

**Sources:** [ext/rfmt/src/logging/logger.rs24-44](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs#L24-L44)

### Log Trait Implementation

The `RfmtLogger` implements three required methods:

**`enabled(&self, metadata: &Metadata) -> bool`**

* Checks if a log message's level should be emitted based on the configured filter
* Returns `true` if `metadata.level() <= self.level`

**`log(&self, record: &Record)`**

* Formats and writes log messages to the output destination
* Format: `[LEVEL] target - message`
* Thread-safe via `Mutex` on the output writer

**`flush(&self)`**

* Forces any buffered log messages to be written immediately
* Called automatically by the logging system when needed

**Sources:** [ext/rfmt/src/logging/logger.rs47-73](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs#L47-L73)

---

## Configuration and Control

### Environment Variables

The logging system responds to multiple environment variables, checked in priority order:

| Variable | Priority | Effect | Example |
| --- | --- | --- | --- |
| `RFMT_LOG` | Highest | Sets exact log level | `RFMT_LOG=debug rfmt file.rb` |
| `DEBUG` | Medium | Enables Info-level logging | `DEBUG=1 rfmt file.rb` |
| `RFMT_DEBUG` | Medium | Enables Info-level logging | `RFMT_DEBUG=1 rfmt file.rb` |
| `RUST_LOG` | Medium | Enables Info-level logging | `RUST_LOG=1 rfmt file.rb` |

**RFMT\_LOG Values:**

* `trace` - Most verbose, shows all internal operations
* `debug` - Detailed debugging information
* `info` - General informational messages
* `warn` - Warnings (default in debug mode)
* `error` - Only critical errors

**Sources:** [ext/rfmt/src/logging/logger.rs26-38](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs#L26-L38) [docs/user\_guide.md440-449](https://github.com/fs0414/rfmt/blob/90c575e6/docs/user_guide.md#L440-L449)

### CLI Flag Integration

The `--verbose` (or `-v`) CLI flag provides user-friendly access to debug logging:

When specified, the Ruby CLI layer sets environment variables before invoking the Rust extension, ensuring debug mode is active.

**Sources:** [docs/user\_guide.md432-438](https://github.com/fs0414/rfmt/blob/90c575e6/docs/user_guide.md#L432-L438)

---

## Log Level Filtering

### Level Hierarchy

Rust's `log` crate defines five levels in increasing severity:

A `LevelFilter` of `Info` will emit `Info`, `Warn`, and `Error` messages but suppress `Debug` and `Trace`.

**Sources:** [ext/rfmt/src/logging/logger.rs48-50](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs#L48-L50)

### Filtering Decision Flow

**Sources:** [ext/rfmt/src/logging/logger.rs47-73](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs#L47-L73)

---

## Output Format

### Message Structure

Each log message follows a consistent format:

```
[LEVEL] target - message
```

**Components:**

| Component | Description | Example |
| --- | --- | --- |
| `LEVEL` | Log level in uppercase | `INFO`, `DEBUG`, `WARN` |
| `target` | Module path or component name | `rfmt::emitter`, `rfmt::config` |
| `message` | The actual log message | `Found config file: "/path/to/.rfmt.yml"` |

**Example Output:**

```
[INFO] rfmt::config - Found config file: "/home/user/project/.rfmt.yml"
[DEBUG] rfmt::emitter - Emitting class node: User
[WARN] rfmt::emitter - Using source extraction for complex parameter defaults
```

**Sources:** [ext/rfmt/src/logging/logger.rs59-66](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs#L59-L66)

### Output Destination

By default, all log messages are written to **stderr** rather than stdout. This ensures:

* Formatted code output (stdout) remains clean and parseable
* Log messages don't interfere with piped operations
* CI/CD systems can separately capture diagnostic output

**Sources:** [ext/rfmt/src/logging/logger.rs14](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs#L14-L14)

---

## Integration with System Components

### Logging Call Sites

The logging system is used throughout the Rust codebase:

**Key Logging Points:**

* **Config Discovery**: Logs when config files are found or defaults are used [ext/rfmt/src/config/mod.rs113-136](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L113-L136)
* **Config Loading**: Logs file reading and parsing operations [ext/rfmt/src/config/mod.rs144-156](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L144-L156)
* **Config Validation**: Logs validation errors [ext/rfmt/src/config/mod.rs159-181](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L159-L181)
* **Emitter Operations**: Debug logging for node processing (implementation details in emitter)

**Sources:** [ext/rfmt/src/logging/logger.rs1-44](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs#L1-L44) [ext/rfmt/src/config/mod.rs104-138](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L104-L138)

---

## Testing Support

### Test-Specific Output

The `RfmtLogger` includes test-specific functionality for verifying log messages:

This method allows tests to inject a custom writer (typically a buffer) to capture log output for assertions.

**Sources:** [ext/rfmt/src/logging/logger.rs18-22](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs#L18-L22)

### Test Structure

The logger tests verify three key behaviors:

| Test | Purpose | Verification |
| --- | --- | --- |
| `test_logger_creation` | Logger initializes with correct level | Checks `enabled()` for different levels |
| `test_logger_level_filtering` | Only messages at or above threshold are emitted | Tests all five log levels |
| `test_logger_output` | Messages are formatted correctly | Verifies format string components |

**Test Implementation:**

Tests use a `TestWriter` struct that wraps an `Arc<Mutex<Vec<u8>>>`, allowing log output to be captured and inspected:

**Sources:** [ext/rfmt/src/logging/logger.rs75-143](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs#L75-L143)

---

## Usage Patterns

### Development Workflow

**Interactive Debugging:**

**CI/CD Integration:**

**Sources:** [docs/user\_guide.md430-456](https://github.com/fs0414/rfmt/blob/90c575e6/docs/user_guide.md#L430-L456)

### Typical Log Messages

**Configuration Discovery:**

```
[INFO] rfmt::config - Found config file: "/project/.rfmt.yml"
[DEBUG] rfmt::config - Found config file in home: "/home/user/.rfmt.yml"
[INFO] rfmt::config - No config file found, using defaults
```

**Emitter Operations:**

```
[DEBUG] rfmt::emitter - Emitting class node: User
[DEBUG] rfmt::emitter - Emitting method node: initialize
[WARN] rfmt::emitter - Using source extraction for complex parameter defaults
```

**Error Conditions:**

```
[ERROR] rfmt::config - Failed to parse config file: invalid YAML syntax
[ERROR] rfmt::config - line_length must be between 40 and 500, got 600
```

**Sources:** [ext/rfmt/src/logging/logger.rs59-66](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs#L59-L66) [ext/rfmt/src/config/mod.rs104-181](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/config/mod.rs#L104-L181)

---

## Implementation Details

### Thread Safety

The `RfmtLogger` uses a `Mutex<Box<dyn Write + Send>>` to ensure thread-safe logging operations. This is critical because:

* Multiple Rust threads may emit log messages concurrently
* The output writer (stderr) is a shared resource
* Message interleaving would produce unreadable output

**Sources:** [ext/rfmt/src/logging/logger.rs7](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs#L7-L7)

### Global Logger Registration

The logger is registered globally via `log::set_boxed_logger()`, which:

* Accepts a `Box<dyn Log>` trait object
* Can only be called once per process (subsequent calls are ignored)
* Returns `Err` if a logger is already set (e.g., in Ruby LSP environments)

The implementation silently ignores registration failures to avoid conflicts with external logging systems.

**Sources:** [ext/rfmt/src/logging/logger.rs41-43](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs#L41-L43)

### Log Level Configuration Precedence

The initialization logic checks environment variables in this order:

1. If `RFMT_LOG` is set, parse and use that value
2. Otherwise, if any of `DEBUG`/`RFMT_DEBUG`/`RUST_LOG` are set, use `Info`
3. Otherwise, use `Warn` (production default)

This allows fine-grained control (`RFMT_LOG=trace`) while maintaining simple boolean flags (`DEBUG=1`) for common cases.

**Sources:** [ext/rfmt/src/logging/logger.rs26-38](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/logging/logger.rs#L26-L38)

Dismiss

Refresh this wiki

Enter email to refresh

### On this page

* [Logging System](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#logging-system)
* [Purpose and Scope](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#purpose-and-scope)
* [Architecture Overview](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#architecture-overview)
* [RfmtLogger Implementation](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#rfmtlogger-implementation)
* [Core Structure](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#core-structure)
* [Initialization Flow](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#initialization-flow)
* [Log Trait Implementation](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#log-trait-implementation)
* [Configuration and Control](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#configuration-and-control)
* [Environment Variables](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#environment-variables)
* [CLI Flag Integration](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#cli-flag-integration)
* [Log Level Filtering](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#log-level-filtering)
* [Level Hierarchy](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#level-hierarchy)
* [Filtering Decision Flow](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#filtering-decision-flow)
* [Output Format](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#output-format)
* [Message Structure](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#message-structure)
* [Output Destination](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#output-destination)
* [Integration with System Components](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#integration-with-system-components)
* [Logging Call Sites](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#logging-call-sites)
* [Testing Support](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#testing-support)
* [Test-Specific Output](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#test-specific-output)
* [Test Structure](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#test-structure)
* [Usage Patterns](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#usage-patterns)
* [Development Workflow](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#development-workflow)
* [Typical Log Messages](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#typical-log-messages)
* [Implementation Details](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#implementation-details)
* [Thread Safety](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#thread-safety)
* [Global Logger Registration](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#global-logger-registration)
* [Log Level Configuration Precedence](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html#log-level-configuration-precedence)
