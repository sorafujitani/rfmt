---
title: "Caching System | fs0414/rfmt | DeepWiki"
source_url: "https://deepwiki.com/fs0414/rfmt/4.5-caching-system"
fetched_at: "2026-01-13T10:53:43.101777+00:00"
---



Loading...

Index your code with Devin

[DeepWiki](https://deepwiki.com/)

[DeepWiki](https://deepwiki.com/)

[fs0414/rfmt](https://github.com/fs0414/rfmt "Open repository")

Index your code with

Devin

Edit WikiShare

Loading...

Last indexed: 3 January 2026 ([90c575](https://github.com/fs0414/rfmt/commits/90c575e6))

* [Overview](https://deepwiki.com/fs0414/rfmt/1-overview.html)
* [Architecture Overview](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html)
* [Key Concepts](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html)
* [Getting Started](https://deepwiki.com/fs0414/rfmt/2-getting-started.html)
* [Installation](https://deepwiki.com/fs0414/rfmt/2.1-installation.html)
* [Configuration](https://deepwiki.com/fs0414/rfmt/2.2-configuration.html)
* [User Guides](https://deepwiki.com/fs0414/rfmt/3-user-guides.html)
* [CLI Usage](https://deepwiki.com/fs0414/rfmt/3.1-cli-usage.html)
* [Ruby API](https://deepwiki.com/fs0414/rfmt/3.2-ruby-api.html)
* [Editor Integration](https://deepwiki.com/fs0414/rfmt/3.3-editor-integration.html)
* [Core Systems](https://deepwiki.com/fs0414/rfmt/4-core-systems.html)
* [AST Representation](https://deepwiki.com/fs0414/rfmt/4.1-ast-representation.html)
* [Formatting Engine (Emitter)](https://deepwiki.com/fs0414/rfmt/4.2-formatting-engine-(emitter).html)
* [Parser Integration (PrismBridge)](https://deepwiki.com/fs0414/rfmt/4.3-parser-integration-(prismbridge).html)
* [Configuration System](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html)
* [Caching System](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html)
* [Logging System](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html)
* [Formatting Behavior](https://deepwiki.com/fs0414/rfmt/5-formatting-behavior.html)
* [Control Flow Formatting](https://deepwiki.com/fs0414/rfmt/5.1-control-flow-formatting.html)
* [Exception Handling Formatting](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html)
* [Lambda and Block Formatting](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html)
* [Development](https://deepwiki.com/fs0414/rfmt/6-development.html)
* [Building from Source](https://deepwiki.com/fs0414/rfmt/6.1-building-from-source.html)
* [Testing](https://deepwiki.com/fs0414/rfmt/6.2-testing.html)
* [Release Process](https://deepwiki.com/fs0414/rfmt/6.3-release-process.html)
* [Reference](https://deepwiki.com/fs0414/rfmt/7-reference.html)
* [Node Types Reference](https://deepwiki.com/fs0414/rfmt/7.1-node-types-reference.html)
* [Configuration Options Reference](https://deepwiki.com/fs0414/rfmt/7.2-configuration-options-reference.html)
* [Error Codes Reference](https://deepwiki.com/fs0414/rfmt/7.3-error-codes-reference.html)
* [Performance and Benchmarks](https://deepwiki.com/fs0414/rfmt/7.4-performance-and-benchmarks.html)

Menu

# Caching System

Relevant source files

* [exe/rfmt](https://github.com/fs0414/rfmt/blob/90c575e6/exe/rfmt)
* [lib/rfmt/cache.rb](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cache.rb)
* [lib/rfmt/cli.rb](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cli.rb)
* [lib/rfmt/configuration.rb](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/configuration.rb)
* [spec/cli\_spec.rb](https://github.com/fs0414/rfmt/blob/90c575e6/spec/cli_spec.rb)

The caching system provides performance optimization by tracking which files have already been formatted, allowing `rfmt` to skip re-formatting unchanged files. This is particularly valuable when running `rfmt` on large codebases or as part of automated workflows where most files remain unchanged between runs.

For information about the CLI commands that invoke caching, see [CLI Usage](https://deepwiki.com/fs0414/rfmt/3.1-cli-usage.html). For details on parallel file processing that works with caching, see [Core Systems](https://deepwiki.com/fs0414/rfmt/4-core-systems.html).

**Sources:** [lib/rfmt/cache.rb1-121](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cache.rb#L1-L121)

---

## Cache Mechanism

The cache uses **SHA256 hashing** to detect file changes. When a file is formatted, `rfmt` computes a hash of the file's content and stores it in the cache. On subsequent runs, it recomputes the hash and compares it against the cached value. If the hashes match, the file is skipped; if they differ (or the file isn't cached), formatting proceeds.

### Hash Comparison Logic

**Sources:** [lib/rfmt/cache.rb25-34](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cache.rb#L25-L34) [lib/rfmt/cache.rb106-111](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cache.rb#L106-L111)

---

## Data Structure

The cache is stored as a JSON file at `~/.cache/rfmt/cache.json` (configurable via `--cache_dir`). Each file path maps to an object containing:

| Field | Type | Description |
| --- | --- | --- |
| `hash` | String | SHA256 hexdigest of file content |
| `formatted_at` | Integer | Unix timestamp when file was last formatted |
| `version` | String | Cache format version (currently "1") |

### Cache File Example

**Sources:** [lib/rfmt/cache.rb13-44](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cache.rb#L13-L44) [lib/rfmt/cache.rb48-51](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cache.rb#L48-L51)

---

## Cache Lifecycle

### Initialization and Load

**Sources:** [lib/rfmt/cache.rb18-23](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cache.rb#L18-L23) [lib/rfmt/cache.rb86-104](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cache.rb#L86-L104)

### Format and Mark Flow

**Sources:** [lib/rfmt/cache.rb25-45](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cache.rb#L25-L45) [lib/rfmt/cli.rb76-82](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cli.rb#L76-L82) [lib/rfmt/cli.rb219-234](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cli.rb#L219-L234)

---

## CLI Integration

### Format Command Cache Options

The `format` command integrates caching through several options:

| Option | Type | Default | Description |
| --- | --- | --- | --- |
| `--cache` | Boolean | `true` | Enable/disable cache usage |
| `--cache_dir` | String | `~/.cache/rfmt` | Custom cache directory path |

### File Filtering with Cache

When caching is enabled, the CLI filters the file list before formatting:

**Sources:** [lib/rfmt/cli.rb70-87](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cli.rb#L70-L87) [lib/rfmt/cli.rb219-234](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cli.rb#L219-L234)

### Cache Update Behavior

The cache is updated in two scenarios:

1. **File was formatted** (`changed = true`): Hash is updated after writing formatted content
2. **File already formatted** (`changed = false`): Hash is still updated to refresh timestamp

This ensures the cache remains accurate even when files are checked but not modified.

**Sources:** [lib/rfmt/cli.rb219-230](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cli.rb#L219-L230)

---

## Cache Management Commands

The CLI provides three cache management subcommands under `rfmt cache`:

### `rfmt cache clear`

Removes all cached entries, forcing all files to be re-formatted on next run.

**Sources:** [lib/rfmt/cli.rb15-22](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cli.rb#L15-L22) [lib/rfmt/cache.rb54-57](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cache.rb#L54-L57)

### `rfmt cache stats`

Displays cache statistics:

Output example:

```
Cache directory: /home/user/.cache/rfmt
Total files in cache: 142
Cache size: 12.45 KB
```

**Sources:** [lib/rfmt/cli.rb24-33](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cli.rb#L24-L33) [lib/rfmt/cache.rb64-71](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cache.rb#L64-L71)

### `rfmt cache prune`

Removes cache entries for files that no longer exist on disk, preventing the cache from growing indefinitely as files are deleted.

**Sources:** [lib/rfmt/cli.rb35-42](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cli.rb#L35-L42) [lib/rfmt/cache.rb73-82](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cache.rb#L73-L82)

---

## Implementation Details

### `Rfmt::Cache` Class Structure

**Sources:** [lib/rfmt/cache.rb7-120](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cache.rb#L7-L120)

### Key Methods

#### `needs_formatting?(file_path)`

Determines whether a file requires formatting by comparing hashes.

Returns `true` if:

* File doesn't exist (edge case)
* File is not in cache
* File hash differs from cached hash

**Sources:** [lib/rfmt/cache.rb25-34](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cache.rb#L25-L34)

#### `mark_formatted(file_path)`

Updates cache entry with current file state after formatting.

**Sources:** [lib/rfmt/cache.rb36-45](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cache.rb#L36-L45)

#### `file_hash(file_path)`

Computes SHA256 hash of file content using OpenSSL.

**Sources:** [lib/rfmt/cache.rb106-111](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cache.rb#L106-L111)

### Error Handling

The cache system handles errors gracefully:

1. **Cache directory creation failure**: Raises `CacheError` with descriptive message
2. **Cache file parse failure**: Warns and starts with empty cache
3. **Cache file read failure**: Warns and starts with empty cache
4. **File hash computation failure**: Raises `CacheError`

This ensures that cache issues never prevent `rfmt` from functioning—formatting can proceed without cache if necessary.

**Sources:** [lib/rfmt/cache.rb86-111](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cache.rb#L86-L111)

---

## Performance Benefits

The caching system provides significant performance improvements:

### Skip Overhead Reduction

When files are cached as already-formatted, `rfmt` avoids:

* Prism parsing (Ruby → AST)
* JSON serialization (AST → JSON)
* FFI boundary crossing (Ruby → Rust)
* Emitter processing (Rust formatting)
* File write operations

### Measurement

The CLI tracks and optionally reports cache hits:

```
ℹ Skipped 47 unchanged file(s) (cached)
Processing 3 file(s)...
```

This is shown in verbose mode (`--verbose`) when files are skipped due to cache hits.

**Sources:** [lib/rfmt/cli.rb76-82](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cli.rb#L76-L82)

### Cache with Parallel Processing

Caching works seamlessly with parallel processing (`--parallel`). Each process reads the shared cache file to determine which files need formatting, then the main process saves the updated cache after all workers complete.

**Sources:** [lib/rfmt/cli.rb96-101](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cli.rb#L96-L101) [lib/rfmt/cli.rb233-234](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cli.rb#L233-L234)

---

## Cache Invalidation Scenarios

The cache automatically becomes invalid when:

1. **File content changes**: Hash comparison detects modifications
2. **File deleted then recreated**: New content produces different hash
3. **Cache version mismatch**: Future cache format updates will invalidate old entries (currently version "1")

Manual invalidation methods:

* `rfmt cache clear`: Clears entire cache
* `cache.invalidate(file_path)`: Removes specific file entry (programmatic API)

**Sources:** [lib/rfmt/cache.rb59-62](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cache.rb#L59-L62) [lib/rfmt/cache.rb54-57](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/cache.rb#L54-L57)

Dismiss

Refresh this wiki

Enter email to refresh

### On this page

* [Caching System](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#caching-system)
* [Cache Mechanism](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#cache-mechanism)
* [Hash Comparison Logic](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#hash-comparison-logic)
* [Data Structure](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#data-structure)
* [Cache File Example](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#cache-file-example)
* [Cache Lifecycle](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#cache-lifecycle)
* [Initialization and Load](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#initialization-and-load)
* [Format and Mark Flow](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#format-and-mark-flow)
* [CLI Integration](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#cli-integration)
* [Format Command Cache Options](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#format-command-cache-options)
* [File Filtering with Cache](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#file-filtering-with-cache)
* [Cache Update Behavior](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#cache-update-behavior)
* [Cache Management Commands](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#cache-management-commands)
* [`rfmt cache clear`](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#rfmt-cache-clear)
* [`rfmt cache stats`](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#rfmt-cache-stats)
* [`rfmt cache prune`](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#rfmt-cache-prune)
* [Implementation Details](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#implementation-details)
* [`Rfmt::Cache` Class Structure](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#rfmtcache-class-structure)
* [Key Methods](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#key-methods)
* [`needs\_formatting?(file\_path)`](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#needs_formattingfile_path)
* [`mark\_formatted(file\_path)`](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#mark_formattedfile_path)
* [`file\_hash(file\_path)`](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#file_hashfile_path)
* [Error Handling](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#error-handling)
* [Performance Benefits](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#performance-benefits)
* [Skip Overhead Reduction](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#skip-overhead-reduction)
* [Measurement](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#measurement)
* [Cache with Parallel Processing](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#cache-with-parallel-processing)
* [Cache Invalidation Scenarios](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html#cache-invalidation-scenarios)
