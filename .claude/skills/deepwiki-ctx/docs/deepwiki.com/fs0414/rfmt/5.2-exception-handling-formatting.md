---
title: "Exception Handling Formatting | fs0414/rfmt | DeepWiki"
source_url: "https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting"
fetched_at: "2026-01-13T10:53:43.101777+00:00"
---



Loading...

Index your code with Devin

[DeepWiki](https://deepwiki.com/)

[DeepWiki](https://deepwiki.com/)

[fs0414/rfmt](https://github.com/fs0414/rfmt "Open repository")

Index your code with

Devin

Edit WikiShare

Loading...

Last indexed: 3 January 2026 ([90c575](https://github.com/fs0414/rfmt/commits/90c575e6))

* [Overview](https://deepwiki.com/fs0414/rfmt/1-overview.html)
* [Architecture Overview](https://deepwiki.com/fs0414/rfmt/1.1-architecture-overview.html)
* [Key Concepts](https://deepwiki.com/fs0414/rfmt/1.2-key-concepts.html)
* [Getting Started](https://deepwiki.com/fs0414/rfmt/2-getting-started.html)
* [Installation](https://deepwiki.com/fs0414/rfmt/2.1-installation.html)
* [Configuration](https://deepwiki.com/fs0414/rfmt/2.2-configuration.html)
* [User Guides](https://deepwiki.com/fs0414/rfmt/3-user-guides.html)
* [CLI Usage](https://deepwiki.com/fs0414/rfmt/3.1-cli-usage.html)
* [Ruby API](https://deepwiki.com/fs0414/rfmt/3.2-ruby-api.html)
* [Editor Integration](https://deepwiki.com/fs0414/rfmt/3.3-editor-integration.html)
* [Core Systems](https://deepwiki.com/fs0414/rfmt/4-core-systems.html)
* [AST Representation](https://deepwiki.com/fs0414/rfmt/4.1-ast-representation.html)
* [Formatting Engine (Emitter)](https://deepwiki.com/fs0414/rfmt/4.2-formatting-engine-(emitter).html)
* [Parser Integration (PrismBridge)](https://deepwiki.com/fs0414/rfmt/4.3-parser-integration-(prismbridge).html)
* [Configuration System](https://deepwiki.com/fs0414/rfmt/4.4-configuration-system.html)
* [Caching System](https://deepwiki.com/fs0414/rfmt/4.5-caching-system.html)
* [Logging System](https://deepwiki.com/fs0414/rfmt/4.6-logging-system.html)
* [Formatting Behavior](https://deepwiki.com/fs0414/rfmt/5-formatting-behavior.html)
* [Control Flow Formatting](https://deepwiki.com/fs0414/rfmt/5.1-control-flow-formatting.html)
* [Exception Handling Formatting](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html)
* [Lambda and Block Formatting](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html)
* [Development](https://deepwiki.com/fs0414/rfmt/6-development.html)
* [Building from Source](https://deepwiki.com/fs0414/rfmt/6.1-building-from-source.html)
* [Testing](https://deepwiki.com/fs0414/rfmt/6.2-testing.html)
* [Release Process](https://deepwiki.com/fs0414/rfmt/6.3-release-process.html)
* [Reference](https://deepwiki.com/fs0414/rfmt/7-reference.html)
* [Node Types Reference](https://deepwiki.com/fs0414/rfmt/7.1-node-types-reference.html)
* [Configuration Options Reference](https://deepwiki.com/fs0414/rfmt/7.2-configuration-options-reference.html)
* [Error Codes Reference](https://deepwiki.com/fs0414/rfmt/7.3-error-codes-reference.html)
* [Performance and Benchmarks](https://deepwiki.com/fs0414/rfmt/7.4-performance-and-benchmarks.html)

Menu

# Exception Handling Formatting

Relevant source files

* [ext/rfmt/src/emitter/mod.rs](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs)
* [lib/rfmt/prism\_bridge.rb](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb)
* [lib/rfmt/prism\_node\_extractor.rb](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_node_extractor.rb)
* [spec/ensure\_formatting\_spec.rb](https://github.com/fs0414/rfmt/blob/90c575e6/spec/ensure_formatting_spec.rb)
* [spec/lambda\_formatting\_spec.rb](https://github.com/fs0414/rfmt/blob/90c575e6/spec/lambda_formatting_spec.rb)

## Purpose and Scope

This document describes how `rfmt` formats Ruby exception handling constructs, including `begin`/`rescue`/`ensure` blocks, implicit exception handling in methods, and rescue modifiers. The formatting engine preserves the semantic structure while ensuring consistent indentation and spacing.

For general control flow formatting (if/unless, case/when, loops), see [Control Flow Formatting](https://deepwiki.com/fs0414/rfmt/5.1-control-flow-formatting.html). For lambda and block formatting, see [Lambda and Block Formatting](https://deepwiki.com/fs0414/rfmt/5.3-lambda-and-block-formatting.html).

---

## Exception Handling Constructs

Ruby provides several exception handling mechanisms that `rfmt` must format:

| Construct | Description | Example |
| --- | --- | --- |
| **Explicit begin/rescue** | Standalone exception handling block | `begin ... rescue ... end` |
| **Implicit rescue** | Exception handling within method definition | `def foo ... rescue ... end` (no explicit `begin`) |
| **Multiple rescue clauses** | Chained rescue for different exception types | `rescue StandardError ... rescue IOError ...` |
| **Exception variables** | Capture exception instance | `rescue => e` or `rescue StandardError => e` |
| **Ensure clause** | Cleanup code that always runs | `ensure ... end` |
| **Rescue modifier** | Inline exception handling | `foo rescue bar` |

---

## AST Representation of Exception Handling

The Prism parser generates distinct node types for exception handling constructs that the Emitter processes:

**Sources:** [lib/rfmt/prism\_bridge.rb175-196](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L175-L196) [ext/rfmt/src/emitter/mod.rs387-538](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L387-L538)

---

## Explicit Begin/Rescue/Ensure Blocks

### Node Dispatch and Formatting

The Emitter dispatches exception handling nodes through specialized methods:

**Sources:** [ext/rfmt/src/emitter/mod.rs149-171](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L149-L171)

### Explicit vs Implicit Begin Blocks

The `emit_begin()` method distinguishes between explicit and implicit begin blocks:

The distinction is made by checking the source code:

| Block Type | Detection Logic | Line Reference |
| --- | --- | --- |
| **Explicit** | Source text starts with "begin" | [ext/rfmt/src/emitter/mod.rs393-400](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L393-L400) |
| **Implicit** | Source text does not start with "begin" | [ext/rfmt/src/emitter/mod.rs414-422](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L414-L422) |

**Sources:** [ext/rfmt/src/emitter/mod.rs387-424](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L387-L424)

### Example: Explicit Begin Block

---

## Rescue Clause Formatting

### Indentation Strategy

Rescue clauses are dedented by 1 level relative to their containing body because they represent control flow at the same level as the method body or begin block:

The dedenting logic is implemented at [ext/rfmt/src/emitter/mod.rs434](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L434-L434):

```
let rescue_indent = indent_level.saturating_sub(1);
```

**Sources:** [ext/rfmt/src/emitter/mod.rs426-514](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L426-L514)

### Exception Classes and Variables

The `emit_rescue()` method extracts exception classes and variables from the source code:

| Component | Extraction Method | Line Reference |
| --- | --- | --- |
| **Exception classes** | Extracted from source text after "rescue" keyword | [ext/rfmt/src/emitter/mod.rs440-484](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L440-L484) |
| **Exception variable** | Included in extracted rescue declaration | [ext/rfmt/src/emitter/mod.rs440-484](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L440-L484) |
| **Multi-line support** | Handles trailing commas and backslashes | [ext/rfmt/src/emitter/mod.rs447-478](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L447-L478) |

### Example: Multi-line Rescue Clause

**Sources:** [ext/rfmt/src/emitter/mod.rs440-484](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L440-L484)

### Chained Rescue Clauses

Multiple rescue clauses are handled recursively. The `RescueNode` children include subsequent rescue clauses:

The recursive emission logic is at [ext/rfmt/src/emitter/mod.rs494-511](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L494-L511):

```
NodeType::RescueNode => {
    // Emit subsequent rescue clause
    // Ensure newline before subsequent rescue
    if !self.buffer.ends_with('\n') {
        self.buffer.push('\n');
    }
    self.emit_rescue(child, indent_level)?;
}
```

**Sources:** [ext/rfmt/src/emitter/mod.rs494-511](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L494-L511)

---

## Ensure Clause Formatting

The `EnsureNode` follows similar indentation rules to rescue clauses:

| Aspect | Implementation | Line Reference |
| --- | --- | --- |
| **Indentation** | Dedented by 1 level (same as rescue) | [ext/rfmt/src/emitter/mod.rs519](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L519-L519) |
| **Comment handling** | Emits comments before ensure keyword | [ext/rfmt/src/emitter/mod.rs521](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L521-L521) |
| **Body emission** | Processes StatementsNode children | [ext/rfmt/src/emitter/mod.rs526-535](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L526-L535) |

### Example: Method with Implicit Ensure

**Sources:** [ext/rfmt/src/emitter/mod.rs516-538](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L516-L538) [spec/ensure\_formatting\_spec.rb14-20](https://github.com/fs0414/rfmt/blob/90c575e6/spec/ensure_formatting_spec.rb#L14-L20)

---

## PrismBridge Integration

The `PrismBridge` extracts children from exception handling nodes:

### BeginNode Children Extraction

[lib/rfmt/prism\_bridge.rb175-180](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L175-L180):

### RescueNode Children Extraction

[lib/rfmt/prism\_bridge.rb190-196](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L190-L196):

### EnsureNode Children Extraction

[lib/rfmt/prism\_bridge.rb181-182](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L181-L182):

**Sources:** [lib/rfmt/prism\_bridge.rb175-196](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L175-L196)

---

## Rescue Modifiers

Rescue modifiers use a different node type (`RescueModifierNode`) and are extracted separately:

[lib/rfmt/prism\_bridge.rb234-235](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L234-L235):

These are typically handled by the generic emitter (`emit_generic()`) since they preserve inline structure.

**Sources:** [lib/rfmt/prism\_bridge.rb234-235](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L234-L235)

---

## Formatting Behavior Examples

### Test Case: Begin-Rescue-Ensure Block

[spec/ensure\_formatting\_spec.rb6-12](https://github.com/fs0414/rfmt/blob/90c575e6/spec/ensure_formatting_spec.rb#L6-L12):

### Test Case: Method with Implicit Ensure

[spec/ensure\_formatting\_spec.rb14-20](https://github.com/fs0414/rfmt/blob/90c575e6/spec/ensure_formatting_spec.rb#L14-L20):

**Sources:** [spec/ensure\_formatting\_spec.rb1-21](https://github.com/fs0414/rfmt/blob/90c575e6/spec/ensure_formatting_spec.rb#L1-L21)

---

## Implementation Summary

### Key Components

| Component | Responsibility | File Location |
| --- | --- | --- |
| **`emit_begin()`** | Format BeginNode (explicit/implicit distinction) | [ext/rfmt/src/emitter/mod.rs387-424](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L387-L424) |
| **`emit_rescue()`** | Format RescueNode with exception info | [ext/rfmt/src/emitter/mod.rs426-514](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L426-L514) |
| **`emit_ensure()`** | Format EnsureNode | [ext/rfmt/src/emitter/mod.rs516-538](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L516-L538) |
| **PrismBridge** | Extract children from exception nodes | [lib/rfmt/prism\_bridge.rb175-196](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L175-L196) |

### Critical Formatting Decisions

1. **Explicit vs Implicit Begin**: Determined by checking if source starts with "begin" keyword
2. **Rescue Indentation**: Dedented by 1 level to align with method definition or begin keyword
3. **Ensure Indentation**: Same dedenting strategy as rescue clauses
4. **Multi-line Rescue**: Handles continuation with trailing commas and backslashes
5. **Chained Rescue**: Recursive emission of subsequent rescue clauses
6. **Source Extraction**: Exception classes and variables extracted from source text rather than reconstructed

**Sources:** [ext/rfmt/src/emitter/mod.rs387-538](https://github.com/fs0414/rfmt/blob/90c575e6/ext/rfmt/src/emitter/mod.rs#L387-L538) [lib/rfmt/prism\_bridge.rb175-196](https://github.com/fs0414/rfmt/blob/90c575e6/lib/rfmt/prism_bridge.rb#L175-L196) [spec/ensure\_formatting\_spec.rb1-21](https://github.com/fs0414/rfmt/blob/90c575e6/spec/ensure_formatting_spec.rb#L1-L21)

Dismiss

Refresh this wiki

Enter email to refresh

### On this page

* [Exception Handling Formatting](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#exception-handling-formatting)
* [Purpose and Scope](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#purpose-and-scope)
* [Exception Handling Constructs](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#exception-handling-constructs)
* [AST Representation of Exception Handling](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#ast-representation-of-exception-handling)
* [Explicit Begin/Rescue/Ensure Blocks](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#explicit-beginrescueensure-blocks)
* [Node Dispatch and Formatting](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#node-dispatch-and-formatting)
* [Explicit vs Implicit Begin Blocks](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#explicit-vs-implicit-begin-blocks)
* [Example: Explicit Begin Block](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#example-explicit-begin-block)
* [Rescue Clause Formatting](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#rescue-clause-formatting)
* [Indentation Strategy](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#indentation-strategy)
* [Exception Classes and Variables](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#exception-classes-and-variables)
* [Example: Multi-line Rescue Clause](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#example-multi-line-rescue-clause)
* [Chained Rescue Clauses](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#chained-rescue-clauses)
* [Ensure Clause Formatting](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#ensure-clause-formatting)
* [Example: Method with Implicit Ensure](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#example-method-with-implicit-ensure)
* [PrismBridge Integration](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#prismbridge-integration)
* [BeginNode Children Extraction](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#beginnode-children-extraction)
* [RescueNode Children Extraction](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#rescuenode-children-extraction)
* [EnsureNode Children Extraction](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#ensurenode-children-extraction)
* [Rescue Modifiers](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#rescue-modifiers)
* [Formatting Behavior Examples](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#formatting-behavior-examples)
* [Test Case: Begin-Rescue-Ensure Block](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#test-case-begin-rescue-ensure-block)
* [Test Case: Method with Implicit Ensure](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#test-case-method-with-implicit-ensure)
* [Implementation Summary](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#implementation-summary)
* [Key Components](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#key-components)
* [Critical Formatting Decisions](https://deepwiki.com/fs0414/rfmt/5.2-exception-handling-formatting.html#critical-formatting-decisions)
